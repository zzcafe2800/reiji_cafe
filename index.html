<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>仮想飲食システム（マルチ店舗版）</title>
<meta name="format-detection" content="telephone=no">
<style>
  :root{
    --bg:#f7efe7; --accent:#b33; --paper:#fff8ef; --dark:#3a2b20; --muted:#8b6d5c;
    --card-skin:#fff2e6;
    --glass: rgba(255,255,255,0.86);
  }
  html,body{height:100%;margin:0;font-family:"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;}
  body{
    min-height:100vh;display:flex;align-items:center;justify-content:center;
    background:url("https://raw.githubusercontent.com/zzcafe2800/reiji_cafe/main/3739270_l.jpg") center center / cover no-repeat;
  }
  .container{width:100%;max-width:420px;margin:0;position:relative;perspective:2000px;aspect-ratio:3/5;}
  .book{position:relative;width:100%;height:100%;}
  .page{position:absolute;inset:0;width:100%;height:100%;overflow:hidden;}
  .cover{
    background:url("https://raw.githubusercontent.com/zzcafe2800/reiji_cafe/main/menuh1.png") center/cover no-repeat;
    transform-origin:right center;z-index:60;pointer-events:auto;
  }
  .cover.open{animation:flip 7.2s ease-in-out forwards;pointer-events:none;}
  .cover.open.finished{display:none;}
  @keyframes flip{
    0%{transform:rotateY(0deg);box-shadow:0 20px 40px rgba(0,0,0,.25);}
    40%{transform:rotateY(-55deg);}
    70%{transform:rotateY(-130deg);}
    100%{transform:rotateY(-180deg);box-shadow:none;}
  }

  .inner{
    position:absolute;inset:0;background:url("https://raw.githubusercontent.com/zzcafe2800/reiji_cafe/main/menuh.png") center / cover no-repeat;
    box-shadow:0 6px 20px rgba(0,0,0,0.15);border-radius:10px;outline:6px solid var(--accent);outline-offset:-6px;
    z-index:1;display:flex;flex-direction:column;overflow:hidden;
  }
  header{display:flex;align-items:center;justify-content:space-between;padding:12px;color:var(--dark);}
  header h1{margin:0;font-size:16px;font-weight:800;letter-spacing:.03em}
  .small-info{font-size:12px;color:var(--muted);}
  .content{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:12px;flex:1;}
  .panel{
    width:100%;max-width:520px;background:var(--glass);border:2px solid #f0c6c6;border-radius:12px;
    padding:10px;box-shadow:0 10px 22px rgba(0,0,0,0.12);
  }

  .order-block{width:100%;max-width:520px;display:flex;flex-direction:column;align-items:center;gap:10px;}
  .status-line{font-weight:800;background:rgba(255,255,255,0.92);padding:8px 12px;border-radius:10px;border:2px solid #f0c6c6;text-align:center;width:100%;}
  .order-row{width:100%;display:flex;gap:10px;align-items:stretch;justify-content:center;}
  .order-btn{
    background:linear-gradient(180deg,#ffd4c4,#ffb38a);border:4px solid var(--accent);color:var(--dark);
    padding:14px 18px;border-radius:14px;cursor:pointer;box-shadow:0 6px 0 #913;user-select:none;
    width:100%;max-width:140px;aspect-ratio:5/3;font-size:clamp(16px,4vw,30px);
    display:flex;align-items:center;justify-content:center;text-align:center;font-weight:900;
  }
  .order-btn.disabled{opacity:0.42;cursor:not-allowed;box-shadow:none;}
  .mini-btn{
    background:#fff;border:2px solid #e6d0c6;border-radius:10px;padding:10px 12px;cursor:pointer;
    font-weight:800;box-shadow:0 4px 12px rgba(0,0,0,0.08);
  }
  .mini-btn:active{transform:translateY(1px)}
  .danger{border-color:#e6a3a3}
  .primary{border-color:#a6d2ff}

  .guest-mini{
    position:fixed;right:12px;bottom:12px;background:var(--paper);padding:10px;border-radius:12px;
    border:1px solid #e6d6cc;font-size:13px;box-shadow:0 8px 18px rgba(0,0,0,0.12);z-index:50;
    min-width:160px;
  }

  .small-pass{
    position:fixed;left:12px;bottom:12px;background:rgba(255,255,255,0.95);padding:8px;border-radius:12px;
    border:1px dashed #c66;display:flex;align-items:center;gap:6px;z-index:60;
  }
  .small-pass input{width:110px;padding:6px;border-radius:8px;border:1px solid #e6d0c6;}
  .small-pass button{padding:8px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:800;}

  .staff-full{
    position:fixed;inset:0;background:linear-gradient(180deg,#fff8f2,#fff3ec);padding:18px;z-index:120;
    display:none;flex-direction:column;overflow:auto;
  }
  .staff-full.show{display:flex;}
  .staff-top{display:flex;justify-content:space-between;align-items:center;gap:10px;}
  .staff-badge{display:flex;flex-direction:column;gap:2px}
  .staff-body{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;}
  .staff-panel{
    flex:1;min-width:300px;background:var(--paper);padding:12px;border-radius:12px;border:1px solid #e6d6cc;
    max-height:560px;overflow:auto;
  }
  .order-item{padding:10px;border-bottom:1px dashed #e6d0c6;display:flex;justify-content:space-between;align-items:flex-start;gap:10px;}
  .order-item strong{font-size:14px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #ddd;background:#fff;font-size:12px;font-weight:800}
  .chip.green{border-color:#79d39a}
  .chip.orange{border-color:#f0c07a}
  .chip.gray{border-color:#ccc;color:#666}

  .big-toggle{display:flex;gap:8px;align-items:center;margin-top:10px;}
  .big-toggle button{flex:1;padding:12px;border-radius:12px;font-size:16px;border:2px solid #c6b3b3;cursor:pointer;font-weight:900;}
  .big-toggle .on{background:#2b8f4a;color:#fff;border-color:#2b8f4a;}
  .big-toggle .off{background:#f0f0f0;color:#666;}

  .menu-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
  .menu-item{
    padding:10px;border:2px solid #e0bdb5;background:#fff;border-radius:12px;text-align:center;cursor:pointer;
    box-shadow:0 6px 14px rgba(0,0,0,0.06);
  }
  img.menu-thumb{width:100%;height:110px;object-fit:cover;border-radius:10px;}
  .stars{font-size:12px;color:#b33;font-weight:900;margin-top:6px}

  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:200;}
  .modal{
    background:#fff;padding:16px;border-radius:14px;width:780px;max-width:95%;
    box-shadow:0 10px 32px rgba(0,0,0,0.35);border:6px solid var(--accent);
  }
  .modal h3{margin:0 0 10px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row input,.row textarea,.row select{
    border:1px solid #e6d0c6;border-radius:10px;padding:10px 12px;font-size:14px;
  }
  .row textarea{width:100%;min-height:90px;resize:vertical}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .btn-red{background:linear-gradient(180deg,#ffb5b5,#ff6b6b);border:2px solid #c33;color:#222;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:900}
  .btn-green{background:linear-gradient(180deg,#8ef0a7,#2b8f4a);border:2px solid #2b8f4a;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:900}
  .btn-gray{background:#f3f3f3;border:2px solid #ddd;color:#444;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:900}

  /* 調理中表示（画像） */
  .status-overlay{
    position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;
    z-index:220;flex-direction:column;color:#111;padding:14px;
  }
  .status-card{
    width:92%;max-width:820px;background:rgba(255,255,255,0.98);padding:16px;border-radius:16px;border:4px solid var(--accent);
    text-align:center;box-shadow:0 18px 40px rgba(0,0,0,0.25);
  }
  .status-main{font-size:22px;font-weight:900;margin-bottom:8px}
  .status-sub{font-size:13px;color:#444}
  .cook-preview{
    margin:10px auto 0 auto;width:260px;height:260px;border-radius:14px;overflow:hidden;border:2px solid #f0c6c6;
    background:#fff;display:flex;align-items:center;justify-content:center;
  }
  .cook-preview img{max-width:100%;max-height:100%;image-rendering:auto}
  .review-mini{
    margin-top:10px;text-align:left;background:#fff;border:1px solid #eee;border-radius:12px;padding:10px;
    font-size:13px;
  }
  .review-mini .head{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .review-mini .text{margin-top:6px;color:#333;line-height:1.45}
  .busy{margin-top:8px;font-size:12px;color:#555}

  /* アートエリア（白縁） */
  .art-area{position:relative;width:240px;height:240px;border-radius:10px;overflow:hidden;border:2px solid #fff;background:#b36e3c;}
  .art-area canvas{position:absolute;left:0;top:0;width:240px;height:240px;}

  /* 飲食モーダル（既存を維持しつつ右側に口コミ） */
  #modalEat .modal{
    width:95%;max-width:980px;background:url("https://raw.githubusercontent.com/zzcafe2800/reiji_cafe/main/3739270_l.jpg") center center / cover no-repeat;
    border-radius:16px;padding:14px;box-shadow:0 12px 30px rgba(0,0,0,0.25);
  }
  #modalEat h3{font-size:14px;color:#fff;opacity:.75;margin:0 0 6px 6px;font-weight:600;}
  .photo-folder{background:#f6efe7;border-radius:12px;padding:10px;box-shadow: inset 0 2px 4px rgba(0,0,0,.1);}
  .photo-frame{background:#fff;border:10px solid #e8dccd;border-bottom:16px solid #d7c6b2;border-radius:6px;box-shadow:0 6px 14px rgba(0,0,0,.25);padding:6px;position:relative;transform:rotate(-1deg);}
  #eatMainWrap{width:100%;height:520px;border-radius:12px;background:#fffdf8;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;box-shadow:inset 0 0 12px rgba(0,0,0,.15);}
  #servedImage{max-width:100%;max-height:100%;border-radius:10px;}
  .side-card{background:rgba(255,255,255,.94);border-radius:14px;padding:10px;box-shadow:0 8px 18px rgba(0,0,0,.15);}
  .photo-stack{display:flex;gap:8px;justify-content:center;margin-top:8px;}
  .mini-frame{background:#fff;border:6px solid #e8dccd;border-bottom:10px solid #d7c6b2;border-radius:4px;padding:4px;box-shadow:0 4px 10px rgba(0,0,0,.2);}

  /* POMODORO（復活） */
  #pomodoroPanel{
    position:absolute;bottom:8px;right:8px;width:230px;aspect-ratio:1/1;background:#fff7e9;border-radius:14px;padding:10px;
    box-shadow:0 8px 18px rgba(0,0,0,.3);transform:scale(0.8);transform-origin:bottom right;overflow:auto;cursor:grab;
    display:none;
  }
  #pomodoroPanel.show{display:block;}
  .pomo-timer{font-family:monospace;font-size:26px;text-align:center;background:#222;color:#7cff7c;padding:6px;border-radius:8px;letter-spacing:2px;font-weight:900;}
  .pomo-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:13px;}
  .pomo-number{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid #e6d0c6;padding:6px;border-radius:10px;flex:1;}
  .pomo-number input{border:none;width:56px;font-weight:900;text-align:center;font-size:14px;outline:none}
  .pomo-btn, #startPomoBtn,#stopPomoBtn,#pausePomoBtn,#skipPomoBtn{
    width:32px;height:32px;border-radius:10px;border:1px solid #ccc;background:#fafafa;cursor:pointer;
    display:inline-flex;align-items:center;justify-content:center;font-weight:900;
  }
  .pomo-start{width:100%;padding:10px;background:linear-gradient(180deg,#6b3,#2b8f4a);color:#fff;border-radius:12px;border:2px solid #2b8f4a;cursor:pointer;font-weight:900;}
  .pomo-controls{display:flex;gap:6px;width:100%;margin-top:8px}
  .pomo-controls button{flex:1}
  .pomo-progress{height:10px;background:#eee;border-radius:999px;overflow:hidden;width:100%;margin-top:8px}
  .pomo-progress > i{display:block;height:100%;background:linear-gradient(90deg,#ffd4c4,#ffb38a);width:0%;}
  @media (max-width:700px){#pomodoroPanel{transform:scale(0.7);transform-origin:bottom right;}}
</style>
</head>

<body>

<div class="container">
  <div class="book">
    <div class="page cover" id="coverPage"></div>

    <div class="page inner">
      <header>
        <h1 id="headerTitle">仮想飲食</h1>
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="small-info">時刻: <span id="nowtime">--:--:--</span></div>
          <button id="xBtn" class="mini-btn primary" title="Xへ" style="padding:8px 10px;">X</button>
        </div>
      </header>

      <div class="content">
        <!-- 店選択 -->
        <div id="shopPicker" class="panel" style="display:none;">
          <div style="font-weight:900;font-size:14px;margin-bottom:10px;">お店を選んでください</div>
          <div id="shopList" style="display:flex;flex-direction:column;gap:10px;"></div>
          <div style="margin-top:10px;border-top:1px dashed #e6d0c6;padding-top:10px;display:flex;justify-content:center;">
            <button id="wantMyShopBtn" class="mini-btn" style="font-size:12px;opacity:.9;">自分のお店用を作りたい方（開発中）</button>
          </div>
        </div>

        <!-- ホーム（店決定後） -->
        <div id="homePanel" class="order-block" style="display:none;">
          <div id="shiftShort" class="status-line">読み込み中...</div>

          <div class="order-row">
            <button id="orderBtn" class="order-btn disabled">注文</button>
          </div>

          <div class="small-info" id="busyInfo" style="margin-top:2px;">混雑: --</div>

          <div style="width:100%;max-width:360px;display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:6px;">
            <div class="small-info">実際の支払いはありません</div>
            <button id="newMenuOfferBtn" class="mini-btn" style="font-size:12px;opacity:.95;">新メニューの提供</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 右下の簡易表示 -->
<div class="guest-mini" id="guestMini">
  <div id="guestRole"><strong>あなた：客</strong></div>
  <div class="small-info" style="margin-top:6px">店：<span id="miniShop">未選択</span></div>
  <div class="small-info">目的：注文</div>
</div>

<!-- 左下：スタッフ入室 -->
<div class="small-pass" id="staffEnterBox">
  <label style="font-size:12px;margin:0;font-weight:900;">店員用</label>
  <input id="staffPass" placeholder="パスワード" />
  <button id="passOk">OK</button>
</div>

<!-- スタッフ画面 -->
<div id="staffFull" class="staff-full" aria-hidden="true">
  <div class="staff-top">
    <div class="staff-badge">
      <strong id="staffBadge">店員</strong>
      <div class="small-info">店員控室（<span id="staffShopName">-</span>）</div>
      <div class="small-info">BOT対応: <span id="botStatusText">-</span></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="botToggleBtn" class="mini-btn">BOT切替</button>
      <button id="logoutStaff" class="mini-btn danger">退室</button>
    </div>
  </div>

  <div style="margin-top:10px;">
    <div class="row">
      <label style="font-weight:900;">シフト開始</label><input id="shiftStart" type="time" />
      <label style="font-weight:900;">終了</label><input id="shiftEnd" type="time" />
      <button id="saveShift" class="mini-btn primary">保存</button>
    </div>

    <div class="big-toggle">
      <button id="shiftBtn" class="off">待機中</button>
      <button id="cookBtn" class="off">料理中</button>
    </div>
  </div>

  <div class="staff-body">
    <div class="staff-panel">
      <strong>スタッフ一覧</strong>
      <div id="shiftList" class="small-info" style="margin-top:8px">読み込み中…</div>
    </div>

    <div class="staff-panel">
      <strong>注文一覧 <span id="pendingTasksSmall" class="small-info"></span></strong>
      <div id="staffOrderList" style="margin-top:8px"></div>
    </div>

    <div class="staff-panel">
      <strong>新メニュー候補（お客さん投稿）</strong>
      <div id="submissionList" class="small-info" style="margin-top:8px">読み込み中…</div>
    </div>
  </div>
</div>

<!-- 状態（待機/調理中）表示：文字ではなく画像中心 -->
<div id="orderStatusOverlay" class="status-overlay" aria-hidden="true">
  <div class="status-card">
    <div class="status-main" id="orderStatusMain">状態</div>
    <div class="status-sub" id="orderStatusSub">しばらくお待ちください</div>

    <div class="cook-preview">
      <img id="cookPreviewImg" src="" alt="調理中のアート" />
    </div>

    <div class="review-mini" id="overlayReviewMini" style="display:none;">
      <div class="head">
        <div style="font-weight:900;">口コミ</div>
        <div id="overlayReviewStars" style="font-weight:900;color:#b33;"></div>
      </div>
      <div class="text" id="overlayReviewText"></div>
    </div>

    <div class="busy" id="overlayBusyText"></div>
  </div>
</div>

<!-- 客：名前入力 -->
<div id="modalOrderName" class="modal-back">
  <div class="modal">
    <h3>ゲーム内の名前</h3>
    <input id="orderName" placeholder="名前を入力" style="width: 300px; height: 54px;" />
    <div class="modal-actions">
      <button id="cancelOrderName" class="btn-gray">キャンセル</button>
      <button id="okOrderName" class="btn-red">決定</button>
    </div>
  </div>
</div>

<!-- 店員：名前入力 -->
<div id="modalStaffName" class="modal-back">
  <div class="modal">
    <h3>店員名</h3>
    <input id="staffName" placeholder="名前を入力" style="width: 300px; height: 54px;" />
    <div class="modal-actions">
      <button id="cancelStaffName" class="btn-gray">キャンセル</button>
      <button id="okStaffName" class="btn-green">入室</button>
    </div>
  </div>
</div>

<!-- 客：メニュー選択 -->
<div id="modalMenu" class="modal-back">
  <div class="modal">
    <h3 id="menuTitle">メニューを選択</h3>
    <div class="menu-grid" id="menuGrid"></div>
    <div class="modal-actions">
      <button id="backMenu" class="btn-gray">戻る</button>
    </div>
  </div>
</div>

<!-- 店員：制作（注ぎ+アート） -->
<div id="modalMake" class="modal-back" style="align-items:flex-start;overflow:auto;">
  <div class="modal" style="width:95%;max-width:920px;">
    <h3 id="makeTitle">制作（担当：<span id="makerName"></span>）</h3>

    <div style="display:flex;flex-wrap:wrap;gap:12px;">
      <div style="flex:1;min-width:280px;">
        <div style="height:220px;display:flex;align-items:center;justify-content:center;">
          <div style="width:180px;height:180px;border-radius:12px;background:#fff8f2;display:flex;align-items:center;justify-content:center;border:2px solid #d2b6ab;position:relative;">
            <div style="position:absolute;left:8px;top:8px;right:8px;bottom:8px;display:flex;align-items:center;justify-content:center;flex-direction:column;">
              <div id="espressoCup" style="width:120px;height:120px;border-radius:60px;overflow:hidden;position:relative;background:#6b3b24;">
                <canvas id="latteCanvas" width="120" height="120" style="display:block;"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:8px;">
          <label id="espressoLabel" style="font-weight:900;">工程①</label>
          <div style="background:#eee;border-radius:10px;padding:10px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <button id="startEsp" class="mini-btn">注ぐ（押し続け）</button>
              <div style="flex:1;position:relative;">
                <div style="height:16px;background:#fff;border-radius:999px;border:1px solid #d4c0b8;overflow:hidden;position:relative;">
                  <div id="espBar" style="height:100%;width:0%;background:linear-gradient(90deg,#a7552b,#6b3);"></div>
                </div>
              </div>
              <div id="espPct" style="width:56px;text-align:right;font-weight:900;">0%</div>
            </div>
            <div class="small-info">合格ゾーン: 95%〜105%</div>
          </div>
        </div>

        <div style="margin-top:8px;">
          <label id="milkLabel" style="font-weight:900;">工程②</label>
          <div style="background:#eee;border-radius:10px;padding:10px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <button id="startMilk" class="mini-btn" disabled>注ぐ（押し続け）</button>
              <div style="flex:1;position:relative;">
                <div style="height:16px;background:#fff;border-radius:999px;border:1px solid #d4c0b8;overflow:hidden;position:relative;">
                  <div id="milkBar" style="height:100%;width:0%;background:linear-gradient(90deg,#fff,#eee);"></div>
                </div>
              </div>
              <div id="milkPct" style="width:56px;text-align:right;font-weight:900;">0%</div>
            </div>
            <div class="small-info">合格ゾーン: 95%〜105%</div>
          </div>
        </div>
      </div>

      <div style="flex:1;min-width:300px;">
        <div style="background:#fff8ef;padding:10px;border-radius:12px;border:1px solid #e0c7bb;">
          <strong id="artLabel">アート</strong>
          <div style="margin-top:10px;">
            <div class="art-area" id="artArea">
              <canvas id="artBg" width="240" height="240"></canvas>
              <canvas id="artLayer" width="240" height="240"></canvas>
            </div>
            <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <label style="font-weight:900;">ツール</label>
              <select id="penMode"><option value="draw">描く</option><option value="erase">消す</option></select>
              <label style="font-weight:900;">太さ</label>
              <select id="penSize"><option value="2">小</option><option value="6" selected>中</option><option value="12">大</option></select>
              <button id="clearArt" class="mini-btn">クリア</button>
            </div>
            <div style="display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap;">
              <label style="font-size:12px;font-weight:900;">背景色</label><input id="artBgColor" type="color" value="#6b3b24"/>
              <label style="font-size:12px;font-weight:900;">ペン色</label><input id="artPenColor" type="color" value="#ffffff"/>
            </div>
            <div class="modal-actions" style="justify-content:space-between;align-items:center;">
              <div id="taskStatusSmall" class="small-info" style="font-weight:900;"></div>
              <div style="display:flex;gap:8px;">
                <button id="saveArt" class="btn-green" disabled>アート保存</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-actions" style="justify-content:flex-end;">
          <button id="completeMake" class="btn-red" disabled>提供する</button>
          <button id="cancelMake" class="btn-gray">中止</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 飲食モーダル（右に口コミ追加、コメント機能は無し） -->
<div id="modalEat" class="modal-back" style="align-items:center;justify-content:center;">
  <div class="modal">
    <h3>飲食</h3>

    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:420px;" class="photo-folder">
        <div class="photo-frame">
          <div id="eatMainWrap">
            <img id="servedImage" src="" alt="商品画像" />
            <div id="pomodoroPanel" aria-hidden="true">
              <div id="pomoSettings">
                <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:6px;">
                  <div style="font-weight:900;">ポロドーモタイマー</div>
                  <div id="pomoCountDisplay" style="font-weight:900;">1 / 1</div>
                </div>

                <div class="pomo-row">
                  <div style="width:52px;font-weight:900;">ループ</div>
                  <div class="pomo-number">
                    <button class="pomo-btn" id="loopDown">-</button>
                    <input id="loopCount" type="number" value="2" min="1" max="10"/>
                    <button class="pomo-btn" id="loopUp">+</button>
                  </div>
                </div>

                <div class="pomo-row">
                  <div style="width:52px;font-weight:900;">作業</div>
                  <div class="pomo-number">
                    <button id="workDown" class="pomo-btn">-</button>
                    <input id="workMin" type="number" value="1"/>
                    <button id="workUp" class="pomo-btn">+</button>
                  </div>
                </div>

                <div class="pomo-row">
                  <div style="width:52px;font-weight:900;">休憩</div>
                  <div class="pomo-number">
                    <button id="breakDown" class="pomo-btn">-</button>
                    <input id="breakMin" type="number" value="5"/>
                    <button id="breakUp" class="pomo-btn">+</button>
                  </div>
                </div>

                <div style="text-align:right;margin-top:8px;">
                  <button id="startPomoBtn" class="pomo-start">再生 ▶</button>
                </div>
              </div>

              <div id="pomoRunning" style="display:none;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div id="pomoLoopCounter" style="font-weight:900;">1 / 1</div>
                  <div id="pomoPhaseLabel" style="font-weight:900;">作業中</div>
                </div>
                <div class="pomo-timer" id="pomoTimerText">00:00:00</div>
                <div class="pomo-progress"><i id="pomoProgressBar"></i></div>
                <div class="pomo-controls">
                  <button id="stopPomoBtn">■</button>
                  <button id="pausePomoBtn">⏸</button>
                  <button id="skipPomoBtn">⏭</button>
                </div>
                <div id="pomoHint" style="font-size:12px;text-align:center;margin-top:6px;">
                  作業した分完食に近づくよ！
                </div>
              </div>
            </div>

          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
          <div id="eatSoundInfo" style="font-weight:900;padding:.6em .9em;background:#fff;border-radius:14px;box-shadow:0 3px 10px rgba(0,0,0,.15);">
            ↑ 画像クリックでタイマー
          </div>
          <button id="saveAllBtn" class="mini-btn" style="margin-left:auto;">画像保存</button>
        </div>
      </div>

      <div style="width:340px;">
        <div class="side-card">
          <div class="photo-stack">
            <div class="mini-frame"><canvas id="servedArtMini" width="220" height="220"></canvas></div>
          </div>

          <div style="margin-top:10px;border-top:1px dashed #e6d0c6;padding-top:10px;">
            <div style="font-weight:900;">口コミ</div>
            <div class="small-info" style="margin-top:6px;">（入力した内容は他の方に見られます）</div>

            <div style="margin-top:10px;">
              <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
                <div style="font-weight:900;">評価</div>
                <div id="reviewStarsPick" style="display:flex;gap:4px;"></div>
                <div class="small-info" id="reviewStarsValue">0/5</div>
              </div>

              <textarea id="reviewText" placeholder="例：待ち時間が短くてうれしい / アートがかわいい など"></textarea>

              <div class="modal-actions" style="justify-content:space-between;">
                <button id="reviewCancel" class="btn-gray">やめる</button>
                <button id="reviewSubmit" class="btn-green">投稿</button>
              </div>
            </div>
          </div>

          <div class="modal-actions" style="justify-content:flex-end;margin-top:8px;">
            <button id="homeFromEat" class="btn-gray">ホームへ</button>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- 新メニュー提供：説明 -->
<div id="modalNewMenuOffer" class="modal-back">
  <div class="modal" style="max-width:720px;">
    <h3>新メニューの提供</h3>
    <div class="panel" style="border:none;box-shadow:none;">
      <div style="font-weight:900;margin-bottom:8px;">説明</div>
      <div class="small-info" style="line-height:1.6;color:#333;">
        お客様が描いた商品が、メニューとして追加されるかも！！<br>
        提出した画像はSNSに掲載されたり、このサイト内で使用されることがあります。<br>
        了承できる方だけ「挑戦」を押してください。
      </div>
    </div>
    <div class="modal-actions">
      <button id="newMenuNo" class="btn-gray">やめる</button>
      <button id="newMenuYes" class="btn-red">挑戦</button>
    </div>
  </div>
</div>

<!-- 新メニュー提供：描く -->
<div id="modalSubmitMenu" class="modal-back" style="align-items:flex-start;overflow:auto;">
  <div class="modal" style="max-width:900px;">
    <h3>新メニューを描く</h3>

    <div class="row" style="margin-bottom:10px;">
      <label style="font-weight:900;">名前</label>
      <input id="submitterName" placeholder="表示名（任意）" style="width:240px;">
      <div class="small-info">※スタッフ画面に表示されます</div>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:320px;">
        <div style="background:#fff8ef;padding:10px;border-radius:12px;border:1px solid #e0c7bb;">
          <div style="font-weight:900;">ペイント</div>
          <div style="margin-top:10px;display:flex;justify-content:center;">
            <div class="art-area" style="width:320px;height:320px;">
              <canvas id="subBg" width="320" height="320"></canvas>
              <canvas id="subLayer" width="320" height="320"></canvas>
            </div>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <label style="font-weight:900;">ツール</label>
            <select id="subMode"><option value="draw">描く</option><option value="erase">消す</option></select>
            <label style="font-weight:900;">太さ</label>
            <select id="subSize"><option value="2">小</option><option value="6" selected>中</option><option value="12">大</option></select>
            <button id="subClear" class="mini-btn">クリア</button>
          </div>

          <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <label style="font-size:12px;font-weight:900;">背景</label><input id="subBgColor" type="color" value="#fff2e6"/>
            <label style="font-size:12px;font-weight:900;">ペン</label><input id="subPenColor" type="color" value="#000000"/>
          </div>

          <div class="modal-actions" style="justify-content:flex-end;">
            <button id="subSaveDraft" class="btn-gray">下書き保存</button>
            <button id="subSubmit" class="btn-green">提出</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button id="subBackHome" class="btn-gray">戻る</button>
    </div>
  </div>
</div>

<script type="module">
/* ===========================
   Firebase imports
=========================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  addDoc,
  updateDoc,
  deleteDoc,
  onSnapshot,
  query,
  orderBy,
  where,
  limit,
  getDoc
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* ===========================
   Firebase config
=========================== */
const firebaseConfig = {
  apiKey: "AIzaSyBJe7_PGeOEkCyC1NxaTMc5bjelQwv2OaU",
  authDomain: "insyoku-f9aee.firebaseapp.com",
  projectId: "insyoku-f9aee",
  storageBucket: "insyoku-f9aee.firebasestorage.app",
  messagingSenderId: "887841835344",
  appId: "1:887841835344:web:249470b39af256b8a34455",
  measurementId: "G-QET0N3KP2L"
};

let app, auth, db;
try{
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
  signInAnonymously(auth).catch(e=>console.warn("anon sign-in failed", e));
}catch(e){
  console.warn("Firebase init failed - offline fallback", e);
  db = null;
}

/* ===========================
   Multi-shop CONFIG (ここを編集)
   - shopId は英数の短いID
   - menus: 使いたい MENUS のID配列
   - staffPass: 店ごとのスタッフ用パス
   - xUrl: 店ごとのX URL
=========================== */
const SHOPS = {
  reiji: {
    id:"reiji",
    name:"0時カフェ",
    menus:["rate","asa","tyoko","pafe","omu"],
    staffPass:"1232",
    xUrl:"https://x.com/zzcafe_280",
    defaultBotEnabled:true,
  },
  zz: {
    id:"zz",
    name:"zzカフェ",
    menus:["rate","omu"],
    staffPass:"9999",
    xUrl:"https://x.com/zzcafe_280",
    defaultBotEnabled:false,
  },
};

/* ===========================
   MENU definitions (IDで参照)
=========================== */
function getAssetUrl(path){
  if (!path) return '';
  if (path.startsWith('@')) return 'https://raw.githubusercontent.com/' + path.slice(1);
  try { return new URL(path).href; } catch(e){ return path; }
}
const MENUS = {
  rate: { id:'rate', title:'カフェ・ラテ', imageBase:'@zzcafe2800/reiji_cafe/main/rate', frameCount:6, lastFrameRandom:true,
    ui:{ makeTitle:'カフェラテ制作', step1:'エスプレッソ注ぎ', step2:'フームドミルク注ぎ' },
    artBg:'#6b3b24', artPen:'#ffffff'
  },
  asa: { id:'asa', title:'食テロ', imageBase:'@zzcafe2800/reiji_cafe/main/asa', frameCount:4, lastFrameRandom:false,
    ui:{ makeTitle:'あさごはん', step1:'ウィンナー焼き', step2:'味噌汁' },
    artBg:'#6b3b24', artPen:'#ffffff'
  },
  tyoko: { id:'tyoko', title:'ケーキ（限定）', imageBase:'@zzcafe2800/reiji_cafe/main/tyoko', frameCount:4, lastFrameRandom:false,
    ui:{ makeTitle:'チョコケーキ', step1:'チョコ', step2:'スポンジ' },
    artBg:'#6b3b24', artPen:'#ffffff'
  },
  pafe: { id:'pafe', title:'パフェ', imageBase:'@zzcafe2800/reiji_cafe/main/pafe', frameCount:3, lastFrameRandom:false,
    ui:{ makeTitle:'パフェ制作', step1:'クリーム注ぎ', step2:'トッピング' },
    artBg:'#6b3b24', artPen:'#ffffff'
  },
  omu: { id:'omu', title:'オムライス', imageBase:'@zzcafe2800/reiji_cafe/main/omu', frameCount:6, lastFrameRandom:true,
    ui:{ makeTitle:'オムライス制作', step1:'ケチャップライス', step2:'卵で包む' },
    artBg:'#ffd66b', artPen:'#ff0000'
  },
};

/* ===========================
   Audio assets
=========================== */
const audioTyaimu = new Audio(getAssetUrl('@zzcafe2800/reiji_cafe/main/tyaimu.mp3'));
const audioCookbgm = new Audio(getAssetUrl('@zzcafe2800/reiji_cafe/main/cookbgm.mp3'));
const audioCookdbgm = new Audio(getAssetUrl('@zzcafe2800/reiji_cafe/main/cookdbgm.mp3'));
const audioPs = new Audio(getAssetUrl('@zzcafe2800/reiji_cafe/main/s1.mp3')); // ←要：ps.mp3 を置いてください（無ければ再生失敗してもOK）
audioCookbgm.loop = true;

/* ===========================
   DOM refs
=========================== */
const coverPage = document.getElementById('coverPage');

const headerTitle = document.getElementById('headerTitle');
const nowtimeEl = document.getElementById('nowtime');
const xBtn = document.getElementById('xBtn');

const shopPicker = document.getElementById('shopPicker');
const shopList = document.getElementById('shopList');
const wantMyShopBtn = document.getElementById('wantMyShopBtn');

const homePanel = document.getElementById('homePanel');
const shiftShort = document.getElementById('shiftShort');
const orderBtn = document.getElementById('orderBtn');
const busyInfo = document.getElementById('busyInfo');
const newMenuOfferBtn = document.getElementById('newMenuOfferBtn');

const guestMini = document.getElementById('guestMini');
const miniShop = document.getElementById('miniShop');

const staffEnterBox = document.getElementById('staffEnterBox');
const staffPass = document.getElementById('staffPass');
const passOk = document.getElementById('passOk');

const staffFull = document.getElementById('staffFull');
const staffBadge = document.getElementById('staffBadge');
const staffShopName = document.getElementById('staffShopName');
const logoutStaff = document.getElementById('logoutStaff');
const shiftStart = document.getElementById('shiftStart');
const shiftEnd = document.getElementById('shiftEnd');
const saveShift = document.getElementById('saveShift');
const shiftBtn = document.getElementById('shiftBtn');
const cookBtn = document.getElementById('cookBtn');
const shiftList = document.getElementById('shiftList');
const staffOrderList = document.getElementById('staffOrderList');
const pendingTasksSmall = document.getElementById('pendingTasksSmall');

const botToggleBtn = document.getElementById('botToggleBtn');
const botStatusText = document.getElementById('botStatusText');

const submissionList = document.getElementById('submissionList');

const orderStatusOverlay = document.getElementById('orderStatusOverlay');
const orderStatusMain = document.getElementById('orderStatusMain');
const orderStatusSub = document.getElementById('orderStatusSub');
const cookPreviewImg = document.getElementById('cookPreviewImg');
const overlayReviewMini = document.getElementById('overlayReviewMini');
const overlayReviewStars = document.getElementById('overlayReviewStars');
const overlayReviewText = document.getElementById('overlayReviewText');
const overlayBusyText = document.getElementById('overlayBusyText');

const modalOrderName = document.getElementById('modalOrderName');
const orderName = document.getElementById('orderName');
const okOrderName = document.getElementById('okOrderName');
const cancelOrderName = document.getElementById('cancelOrderName');

const modalStaffName = document.getElementById('modalStaffName');
const staffName = document.getElementById('staffName');
const okStaffName = document.getElementById('okStaffName');
const cancelStaffName = document.getElementById('cancelStaffName');

const modalMenu = document.getElementById('modalMenu');
const menuTitle = document.getElementById('menuTitle');
const menuGrid = document.getElementById('menuGrid');
const backMenu = document.getElementById('backMenu');

const modalMake = document.getElementById('modalMake');
const makeTitle = document.getElementById('makeTitle');
const makerName = document.getElementById('makerName');
const espressoLabel = document.getElementById('espressoLabel');
const milkLabel = document.getElementById('milkLabel');
const startEsp = document.getElementById('startEsp');
const startMilk = document.getElementById('startMilk');
const espBar = document.getElementById('espBar');
const milkBar = document.getElementById('milkBar');
const espPct = document.getElementById('espPct');
const milkPct = document.getElementById('milkPct');

const latteCanvas = document.getElementById('latteCanvas');
const latteCtx = latteCanvas.getContext('2d');

const artBg = document.getElementById('artBg');
const artLayer = document.getElementById('artLayer');
const artBgCtx = artBg.getContext('2d');
const artLayerCtx = artLayer.getContext('2d');
const penMode = document.getElementById('penMode');
const penSize = document.getElementById('penSize');
const clearArt = document.getElementById('clearArt');
const saveArt = document.getElementById('saveArt');
const artBgColor = document.getElementById('artBgColor');
const artPenColor = document.getElementById('artPenColor');

const taskStatusSmall = document.getElementById('taskStatusSmall');
const completeMake = document.getElementById('completeMake');
const cancelMake = document.getElementById('cancelMake');

const modalEat = document.getElementById('modalEat');
const servedImage = document.getElementById('servedImage');
const servedArtMini = document.getElementById('servedArtMini');
const servedCardMini = document.getElementById('servedCardMini'); // 互換のため残す（今回は未使用でもOK）
const saveAllBtn = document.getElementById('saveAllBtn');
const homeFromEat = document.getElementById('homeFromEat');

const reviewStarsPick = document.getElementById('reviewStarsPick');
const reviewStarsValue = document.getElementById('reviewStarsValue');
const reviewText = document.getElementById('reviewText');
const reviewSubmit = document.getElementById('reviewSubmit');
const reviewCancel = document.getElementById('reviewCancel');

const pomodoroPanel = document.getElementById('pomodoroPanel');
const pomoSettings = document.getElementById('pomoSettings');
const pomoRunning = document.getElementById('pomoRunning');
const loopCountInput = document.getElementById('loopCount');
const workMinInput = document.getElementById('workMin');
const breakMinInput = document.getElementById('breakMin');
const loopUp = document.getElementById('loopUp');
const loopDown = document.getElementById('loopDown');
const workUp = document.getElementById('workUp');
const workDown = document.getElementById('workDown');
const breakUp = document.getElementById('breakUp');
const breakDown = document.getElementById('breakDown');
const startPomoBtn = document.getElementById('startPomoBtn');
const stopPomoBtn = document.getElementById('stopPomoBtn');
const pausePomoBtn = document.getElementById('pausePomoBtn');
const skipPomoBtn = document.getElementById('skipPomoBtn');
const pomoLoopCounter = document.getElementById('pomoLoopCounter');
const pomoPhaseLabel = document.getElementById('pomoPhaseLabel');
const pomoTimerText = document.getElementById('pomoTimerText');
const pomoProgressBar = document.getElementById('pomoProgressBar');
const pomoCountDisplay = document.getElementById('pomoCountDisplay');
const eatSoundInfo = document.getElementById('eatSoundInfo');

const modalNewMenuOffer = document.getElementById('modalNewMenuOffer');
const newMenuNo = document.getElementById('newMenuNo');
const newMenuYes = document.getElementById('newMenuYes');

const modalSubmitMenu = document.getElementById('modalSubmitMenu');
const submitterName = document.getElementById('submitterName');
const subBg = document.getElementById('subBg');
const subLayer = document.getElementById('subLayer');
const subBgCtx = subBg.getContext('2d');
const subLayerCtx = subLayer.getContext('2d');
const subMode = document.getElementById('subMode');
const subSize = document.getElementById('subSize');
const subClear = document.getElementById('subClear');
const subBgColor = document.getElementById('subBgColor');
const subPenColor = document.getElementById('subPenColor');
const subSaveDraft = document.getElementById('subSaveDraft');
const subSubmit = document.getElementById('subSubmit');
const subBackHome = document.getElementById('subBackHome');

/* ===========================
   App state
=========================== */
const state = {
  currentShopId: null,
  currentShop: null,
  currentUser: { role:'guest', staffId:null },
  staffs: [],
  orders: [],
  reviews: [],
  submissions: [],
  settings: { botEnabled:true },
  currentOrderIdForClient: null,
  currentMenuIdForClient: null,
};
let clientId = localStorage.getItem('reiji_clientId');
if (!clientId){ clientId = 'c_' + Math.random().toString(36).slice(2,9); localStorage.setItem('reiji_clientId', clientId); }

/* ===========================
   Helpers
=========================== */
function show(el){ el.style.display = 'flex'; el.setAttribute('aria-hidden','false'); }
function hide(el){ el.style.display = 'none'; el.setAttribute('aria-hidden','true'); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function uid(p='id'){ return p + Math.random().toString(36).slice(2,9); }
function nowInJST(){
  const s = new Date().toLocaleString('en-US', { timeZone: 'Asia/Tokyo' });
  return new Date(s);
}
setInterval(()=> nowtimeEl.textContent = nowInJST().toLocaleTimeString(), 1000);

/* シフト判定（スタッフの時間基準：JSTで固定） */
function isNowWithinShift(start,end,dateObj){
  if (!start || !end) return false;
  const [sh,sm] = start.split(':').map(Number); const [eh,em] = end.split(':').map(Number);
  const sDate = new Date(dateObj); sDate.setHours(sh,sm,0,0);
  const eDate = new Date(dateObj); eDate.setHours(eh,em,0,0);
  if (eDate <= sDate) eDate.setDate(eDate.getDate()+1);
  return dateObj >= sDate && dateObj <= eDate;
}

/* 店ごとの Firestore パス */
function colStaffs(){ return collection(db, 'shops', state.currentShopId, 'staffs'); }
function colOrders(){ return collection(db, 'shops', state.currentShopId, 'orders'); }
function colReviews(){ return collection(db, 'shops', state.currentShopId, 'reviews'); }
function colSubmissions(){ return collection(db, 'shops', state.currentShopId, 'submissions'); }
function colSignals(){ return collection(db, 'shops', state.currentShopId, 'signals'); }
function docSettings(){ return doc(db, 'shops', state.currentShopId, 'settings', 'main'); }
function docMenuStat(menuId){ return doc(db, 'shops', state.currentShopId, 'menuStats', menuId); }

/* ===========================
   Shop picker UI
=========================== */
function renderShopPicker(){
  shopList.innerHTML = '';
  Object.values(SHOPS).forEach(shop=>{
    const row = document.createElement('div');
    row.style.display='flex';
    row.style.alignItems='center';
    row.style.justifyContent='space-between';
    row.style.gap='10px';
    row.style.background='#fff';
    row.style.border='1px solid #e6d0c6';
    row.style.borderRadius='12px';
    row.style.padding='10px 12px';
    row.style.boxShadow='0 6px 14px rgba(0,0,0,0.06)';
    row.innerHTML = `<div style="font-weight:900;">${escapeHtml(shop.name)}</div>`;
    const btn = document.createElement('button');
    btn.className = 'mini-btn primary';
    btn.textContent = '来店';
    btn.onclick = ()=> selectShop(shop.id);
    row.appendChild(btn);
    shopList.appendChild(row);
  });
}
wantMyShopBtn.onclick = ()=>{
  alert('開発中です。');
};

/* ===========================
   Cover motion restore
=========================== */
function openCover(){
  if (!coverPage) return;
  coverPage.classList.add('open');
  coverPage.addEventListener('animationend', ()=>{
    coverPage.classList.add('finished');
    try{ coverPage.remove(); }catch(e){}
  }, { once:true });
}
/* 1回目のタップで開く（モーション復活） */
document.addEventListener('click', function onFirst(){
  openCover();
  document.removeEventListener('click', onFirst);
}, { once:true });

/* ===========================
   Shop selection + listeners
=========================== */
let unsub = [];
function clearListeners(){
  unsub.forEach(fn=>{ try{ fn(); }catch(e){} });
  unsub = [];
}

async function ensureSettings(){
  if (!db) {
    state.settings.botEnabled = state.currentShop?.defaultBotEnabled ?? true;
    renderBotStatus();
    return;
  }
  try{
    const sref = docSettings();
    const snap = await getDoc(sref);
    if (snap.exists()){
      state.settings = { botEnabled: !!snap.data().botEnabled };
    }else{
      state.settings = { botEnabled: state.currentShop?.defaultBotEnabled ?? true };
      await updateDoc(sref, { botEnabled: state.settings.botEnabled }).catch(async ()=>{
        // docが無い場合は add できないので addDoc ではなく set 相当が必要だが、ここでは簡易：addDoc できない
        // 代替：addDocではなく updateDoc 失敗時は何もしない（初回はUI側だけ）
      });
    }
  }catch(e){
    state.settings.botEnabled = state.currentShop?.defaultBotEnabled ?? true;
  }
  renderBotStatus();
}

function startListeners(){
  if (!db) return;

  // staffs
  unsub.push(onSnapshot(query(colStaffs(), orderBy('createdAt','asc')), snap=>{
    state.staffs = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderShiftShort();
    renderShiftList();
    updateOrderButtonState();
  }));

  // orders
  unsub.push(onSnapshot(query(colOrders(), orderBy('createdAt','asc')), snap=>{
    state.orders = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderOrderList();
    updateClientOverlay();
    renderBusy();
  }));

  // reviews（最近のみ）
  unsub.push(onSnapshot(query(colReviews(), orderBy('createdAt','desc'), limit(60)), snap=>{
    state.reviews = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    // メニュー表示やオーバーレイ用
    // buildMenu() の表示星は都度計算
  }));

  // submissions
  unsub.push(onSnapshot(query(colSubmissions(), orderBy('createdAt','desc'), limit(30)), snap=>{
    state.submissions = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderSubmissionList();
  }));

  // settings
  unsub.push(onSnapshot(docSettings(), snap=>{
    if (snap.exists()){
      state.settings = { botEnabled: !!snap.data().botEnabled };
      renderBotStatus();
      updateOrderButtonState();
      renderShiftShort();
    }
  }));

  // signals（tyaimu: 店員控室にいる人だけ鳴らす）
  unsub.push(onSnapshot(query(colSignals(), orderBy('ts','asc'), limit(50)), snap=>{
    // “新しい”だけ鳴らす：local lastTs
    if (!state._lastSignalTs) state._lastSignalTs = 0;
    snap.docs.forEach(d=>{
      const data = d.data();
      if (!data || !data.ts) return;
      if (data.ts <= state._lastSignalTs) return;
      state._lastSignalTs = data.ts;

      // type=tyaimu は、スタッフ画面を開いている人だけ
      if (data.type === 'tyaimu'){
        if (state.currentUser.role === 'staff' && staffFull.classList.contains('show')){
          try{ audioTyaimu.currentTime=0; audioTyaimu.play().catch(()=>{}); }catch(e){}
        }
      }
    });
  }));
}

async function selectShop(shopId){
  const shop = SHOPS[shopId];
  if (!shop){ alert('店が見つかりません'); return; }
  state.currentShopId = shopId;
  state.currentShop = shop;
  headerTitle.textContent = shop.name;
  miniShop.textContent = shop.name;
  staffShopName.textContent = shop.name;

  // XボタンのURLを店ごとに
  xBtn.onclick = ()=> window.open(shop.xUrl || 'https://x.com/', '_blank');

  // UI切替
  shopPicker.style.display = 'none';
  homePanel.style.display = 'flex';

  // listeners restart
  clearListeners();
  await ensureSettings();
  startListeners();

  // 初期描画
  renderShiftShort();
  updateOrderButtonState();
  renderBusy();
}

/* ===========================
   Shift short + busy
=========================== */
function getHumanActiveStaffs(){
  const now = nowInJST();
  return state.staffs.filter(s => !!s.onShift && isNowWithinShift(s.shiftStart,s.shiftEnd,now));
}
function renderBotStatus(){
  botStatusText.textContent = state.settings.botEnabled ? 'ON' : 'OFF';
  botStatusText.style.fontWeight = '900';
}
function renderBusy(){
  const pending = (state.orders||[]).filter(o=>o.state==='waiting' || o.state==='inprogress').length;
  busyInfo.textContent = `混雑: ${pending}件`;
}
function renderShiftShort(){
  if (!state.currentShop) return;
  const active = getHumanActiveStaffs();
  if (active.length){
    const names = active.map(s=>{
      const st = (s.status === 'cooking') ? '料理中' : '待機中';
      return `${s.name}（${st}）`;
    }).join(' / ');
    shiftShort.textContent = `シフト：${names}`;
    return;
  }
  // 無人
  if (state.settings.botEnabled){
    shiftShort.textContent = 'シフト：BOT対応中（無人）';
  }else{
    shiftShort.textContent = 'シフト：無人（注文停止中）';
  }
}

/* 注文ボタン：BOT OFF かつ無人なら押せない */
function updateOrderButtonState(){
  if (!state.currentShop) return;
  const active = getHumanActiveStaffs();
  const canOrder = active.length > 0 || state.settings.botEnabled;
  if (canOrder){
    orderBtn.classList.remove('disabled');
  }else{
    orderBtn.classList.add('disabled');
  }
}

/* ===========================
   Staff list UI (名前横に状態)
=========================== */
function renderShiftList(){
  shiftList.innerHTML = '';
  const now = nowInJST();
  state.staffs.forEach(s=>{
    const div = document.createElement('div');
    div.style.padding = '8px 0';
    const onNow = isNowWithinShift(s.shiftStart,s.shiftEnd,now);
    const st = (s.status === 'cooking') ? '料理中' : '待機中';
    const stChip = (s.status === 'cooking') ? '<span class="chip orange">料理中</span>' : '<span class="chip green">待機中</span>';
    const timeInfo = `${escapeHtml(s.shiftStart||'--:--')}〜${escapeHtml(s.shiftEnd||'--:--')}`;
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <strong>${escapeHtml(s.name)}</strong>
        ${stChip}
        <span class="chip gray">${timeInfo}</span>
        ${onNow ? '<span class="small-info" style="font-weight:900;">（現在この時間）</span>' : ''}
      </div>
    `;
    // 削除
    const delBtn = document.createElement('button');
    delBtn.className='mini-btn danger';
    delBtn.style.padding='6px 10px';
    delBtn.style.fontSize='12px';
    delBtn.textContent='削除';
    delBtn.onclick = async ()=>{
      if (!s.id) return;
      if (db){
        try{ await deleteDoc(doc(db,'shops',state.currentShopId,'staffs',s.id)); }catch(e){}
      }else{
        state.staffs = state.staffs.filter(x=>x.id!==s.id);
        renderShiftList(); renderShiftShort(); updateOrderButtonState();
      }
    };
    div.appendChild(delBtn);
    shiftList.appendChild(div);
  });
}

/* ===========================
   Staff login (店ごとのパス)
=========================== */
passOk.onclick = ()=>{
  if (!state.currentShop){ alert('先にお店を選んでください'); return; }
  if (staffPass.value !== (state.currentShop.staffPass||'')){ alert('パスワードが違います'); return; }
  staffName.value = '';
  show(modalStaffName);
};
cancelStaffName.onclick = ()=> hide(modalStaffName);
okStaffName.onclick = async ()=>{
  const name = staffName.value.trim();
  if (!name){ alert('名前を入力してください'); return; }
  hide(modalStaffName);

  try{
    if (db){
      const ref = await addDoc(colStaffs(), {
        name, shiftStart:'09:00', shiftEnd:'17:00',
        onShift:true,
        status:'idle', // idle / cooking
        createdAt: Date.now()
      });
      enterStaffFull(name, ref.id);
    }else{
      const s = { id:uid('s'), name, shiftStart:'09:00', shiftEnd:'17:00', onShift:true, status:'idle', createdAt:Date.now() };
      state.staffs.push(s);
      enterStaffFull(name, s.id);
    }
  }catch(e){
    console.warn(e);
  }
};

function enterStaffFull(name, staffId){
  state.currentUser = { role:'staff', staffId };
  staffBadge.textContent = name;
  staffFull.classList.add('show');
  staffFull.setAttribute('aria-hidden','false');
  renderShiftList();
  renderOrderList();
  renderBotStatus();
  updateStaffToggleUI();
}

/* 退室 */
logoutStaff.onclick = async ()=>{
  const id = state.currentUser.staffId;
  if (id){
    if (db){
      try{ await deleteDoc(doc(db,'shops',state.currentShopId,'staffs',id)); }catch(e){}
    }else{
      state.staffs = state.staffs.filter(s=>s.id!==id);
    }
  }
  state.currentUser = { role:'guest', staffId:null };
  staffFull.classList.remove('show');
  staffFull.setAttribute('aria-hidden','true');
};

/* スタッフ：シフト保存 */
saveShift.onclick = async ()=>{
  const id = state.currentUser.staffId; if (!id) return;
  const payload = { shiftStart:shiftStart.value||'09:00', shiftEnd:shiftEnd.value||'17:00' };
  if (db){
    try{ await updateDoc(doc(db,'shops',state.currentShopId,'staffs',id), payload); }catch(e){}
  }else{
    const s = state.staffs.find(x=>x.id===id); if (s) Object.assign(s,payload);
    renderShiftList(); renderShiftShort();
  }
};

/* スタッフ：状態トグル（待機/料理中） */
function updateStaffToggleUI(){
  const id = state.currentUser.staffId;
  if (!id) return;
  const me = state.staffs.find(s=>s.id===id);
  const cooking = me && me.status === 'cooking';
  if (me && me.onShift){
    // onShift は true を維持（時間帯で有効）
    if (cooking){
      cookBtn.classList.add('on'); cookBtn.classList.remove('off');
      shiftBtn.classList.add('off'); shiftBtn.classList.remove('on');
    }else{
      shiftBtn.classList.add('on'); shiftBtn.classList.remove('off');
      cookBtn.classList.add('off'); cookBtn.classList.remove('on');
    }
  }else{
    shiftBtn.classList.add('off'); shiftBtn.classList.remove('on');
    cookBtn.classList.add('off'); cookBtn.classList.remove('on');
  }
}
shiftBtn.onclick = async ()=>{
  const id = state.currentUser.staffId; if (!id) return;
  if (db){
    try{ await updateDoc(doc(db,'shops',state.currentShopId,'staffs',id), { onShift:true, status:'idle' }); }catch(e){}
  }else{
    const s=state.staffs.find(x=>x.id===id); if (s){ s.onShift=true; s.status='idle'; renderShiftList(); renderShiftShort(); }
  }
  updateStaffToggleUI();
};
cookBtn.onclick = async ()=>{
  const id = state.currentUser.staffId; if (!id) return;
  if (db){
    try{ await updateDoc(doc(db,'shops',state.currentShopId,'staffs',id), { onShift:true, status:'cooking' }); }catch(e){}
  }else{
    const s=state.staffs.find(x=>x.id===id); if (s){ s.onShift=true; s.status='cooking'; renderShiftList(); renderShiftShort(); }
  }
  updateStaffToggleUI();
};

/* BOT切替（スタッフ画面で変更） */
botToggleBtn.onclick = async ()=>{
  const next = !state.settings.botEnabled;
  state.settings.botEnabled = next;
  renderBotStatus();
  renderShiftShort();
  updateOrderButtonState();
  if (db){
    try{
      // settings/main が無い可能性もあるので、update失敗してもUIは維持
      await updateDoc(docSettings(), { botEnabled: next });
    }catch(e){
      console.warn('bot toggle save failed', e);
    }
  }
};

/* ===========================
   Menu build (店ごとに変わる)
   - メニューごとの平均星（簡易計算）
=========================== */
function calcMenuAvg(menuId){
  const list = (state.reviews||[]).filter(r=>r.menuId===menuId);
  if (!list.length) return { avg:0, count:0 };
  const sum = list.reduce((a,b)=>a+(Number(b.stars)||0),0);
  return { avg: sum/list.length, count:list.length };
}
function starString(avg){
  const n = Math.round(avg);
  let s = '';
  for (let i=0;i<5;i++) s += (i<n?'★':'☆');
  return s;
}

async function buildMenu(){
  menuGrid.innerHTML = '';
  if (!state.currentShop) return;
  const ids = state.currentShop.menus || [];
  for (const id of ids){
    const it = MENUS[id];
    if (!it) continue;
    const div = document.createElement('div');
    div.className='menu-item';

    const img = document.createElement('img');
    img.className='menu-thumb';
    // 1枚目を表示
    const url = getAssetUrl(it.imageBase + '1.png');
    try{
      const res = await fetch(url);
      if (res.ok){
        const blob = await res.blob();
        img.src = URL.createObjectURL(blob);
      }else{
        img.src = url;
      }
    }catch(e){
      img.src = url;
    }

    const title = document.createElement('div');
    title.style.fontWeight='900';
    title.style.marginTop='6px';
    title.textContent = it.title;

    const st = calcMenuAvg(it.id);
    const stars = document.createElement('div');
    stars.className='stars';
    stars.textContent = st.count ? `${starString(st.avg)} (${st.count})` : `☆☆☆☆☆`;

    div.appendChild(img);
    div.appendChild(title);
    div.appendChild(stars);

    div.onclick = ()=> onMenuSelect(it);
    menuGrid.appendChild(div);
  }
}

/* ===========================
   Order flow (tyaimu: メニュー画像を押したときだけ)
=========================== */
orderBtn.onclick = ()=>{
  if (orderBtn.classList.contains('disabled')) return;
  orderName.value = '';
  show(modalOrderName);
};
cancelOrderName.onclick = ()=> hide(modalOrderName);
okOrderName.onclick = async ()=>{
  const name = orderName.value.trim();
  if (!name){ alert('名前を入力してください'); return; }
  hide(modalOrderName);

  // メニューへ
  await buildMenu();
  show(modalMenu);
};
backMenu.onclick = ()=> hide(modalMenu);

/* メニュー選択時に tyaimu を「本人 + スタッフ控室だけ」鳴らす */
async function emitTyaimuSignal(){
  try{
    // 本人はローカルで鳴らす
    try{ audioTyaimu.currentTime=0; audioTyaimu.play().catch(()=>{}); }catch(e){}
    // スタッフ控室は signals で鳴らす（店ごと）
    if (db){
      await addDoc(colSignals(), { type:'tyaimu', ts: Date.now() });
    }
  }catch(e){
    console.warn('emit signal failed', e);
  }
}

async function onMenuSelect(menuItem){
  hide(modalMenu);
  const name = orderName.value.trim() || '名無し';
  state.currentMenuIdForClient = menuItem.id;

  // tyaimu はここで
  await emitTyaimuSignal();

  // 注文作成
  const createdAt = Date.now();
  const orderObj = {
    name,
    menuId: menuItem.id,
    state: 'waiting', // waiting -> inprogress -> delivered
    createdAt,
    clientId,
    assignedTo: null,
    assignedToName: null,
    cookingPreview: null, // 調理中のアート画像（低画質）
    servedImageData: null,
    artDataUrl: null,
    artBg: menuItem.artBg || '#6b3b24',
  };

  const active = getHumanActiveStaffs();

  // 無人の場合：BOT ONなら即提供（簡易BOT）
  if (!active.length){
    if (!state.settings.botEnabled){
      alert('今はシフトがいないため注文できません。');
      return;
    }
    showClientStatus('BOTが料理中…', '少し待ってね');
    const served = await botProduce(menuItem, name);
    orderObj.state = 'delivered';
    orderObj.servedImageData = served.servedImageData;
    orderObj.artDataUrl = served.artDataUrl;
    orderObj.cookingPreview = served.cookingPreview;

    if (db){
      try{
        const ref = await addDoc(colOrders(), { ...orderObj, deliveredAt: Date.now() });
        state.currentOrderIdForClient = ref.id;
      }catch(e){
        console.warn(e);
        // fallback local
        orderObj.id = uid('o'); state.orders.push(orderObj); state.currentOrderIdForClient = orderObj.id;
      }
    }else{
      orderObj.id = uid('o'); state.orders.push(orderObj); state.currentOrderIdForClient = orderObj.id;
    }

    hideClientStatus();
    await showClientServed(orderObj);
    return;
  }

  // 人がいる：通常
  try{
    if (db){
      const ref = await addDoc(colOrders(), orderObj);
      state.currentOrderIdForClient = ref.id;
    }else{
      orderObj.id = uid('o'); state.orders.push(orderObj); state.currentOrderIdForClient = orderObj.id;
    }
    showClientStatus('現在対応待ち中', '店員さんが対応します');
  }catch(e){
    console.warn(e);
    alert('注文に失敗しました');
  }
}

/* ===========================
   Staff: Order list + assign + make
=========================== */
function renderOrderList(){
  staffOrderList.innerHTML = '';
  const pending = (state.orders||[]).filter(o=>o.state==='waiting' || o.state==='inprogress').length;
  pendingTasksSmall.textContent = pending ? ` 未処理:${pending}` : '';

  (state.orders||[]).forEach(o=>{
    if (!o) return;
    if (o.state === 'delivered' || o.state === 'cancelled') return;

    const div = document.createElement('div');
    div.className='order-item';

    const left = document.createElement('div');
    left.innerHTML = `
      <strong>${escapeHtml(o.name)}</strong>
      <div class="small-info" style="margin-top:4px;">
        メニュー: ${escapeHtml(MENUS[o.menuId]?.title || o.menuId || '-')}
        / 状態: ${escapeHtml(o.state)}
      </div>
    `;

    const right = document.createElement('div');
    right.style.display='flex';
    right.style.flexDirection='column';
    right.style.gap='8px';
    right.style.alignItems='flex-end';

    if (o.state === 'waiting'){
      const btn = document.createElement('button');
      btn.className='mini-btn primary';
      btn.textContent='対応';
      btn.onclick = ()=> assignOrder(o.id);
      right.appendChild(btn);
    }else if (o.state === 'inprogress'){
      const info = document.createElement('div');
      info.className='small-info';
      info.style.fontWeight='900';
      info.textContent = `担当: ${o.assignedToName || o.assignedTo || ''}`;
      right.appendChild(info);

      const btn = document.createElement('button');
      btn.className='mini-btn';
      btn.textContent='制作';
      btn.onclick = ()=> openMakeModal(o);
      right.appendChild(btn);
    }

    div.appendChild(left);
    div.appendChild(right);
    staffOrderList.appendChild(div);
  });
}

async function assignOrder(orderId){
  const staffId = state.currentUser.staffId;
  if (!staffId){ alert('スタッフとして入室してください'); return; }
  const me = state.staffs.find(s=>s.id===staffId);
  if (!me){ alert('スタッフ情報が見つかりません'); return; }

  try{
    if (db){
      await updateDoc(doc(db,'shops',state.currentShopId,'orders',orderId), {
        state:'inprogress',
        assignedTo: staffId,
        assignedToName: me.name,
      });
      // 状態も料理中に寄せる（任意）
      await updateDoc(doc(db,'shops',state.currentShopId,'staffs',staffId), { status:'cooking', onShift:true }).catch(()=>{});
      try{ audioCookbgm.currentTime=0; audioCookbgm.play().catch(()=>{}); }catch(e){}
    }else{
      const o = state.orders.find(x=>x.id===orderId);
      if (o){ o.state='inprogress'; o.assignedTo=staffId; o.assignedToName=me.name; }
      try{ audioCookbgm.currentTime=0; audioCookbgm.play().catch(()=>{}); }catch(e){}
      renderOrderList();
    }
  }catch(e){
    console.warn(e);
  }
}

/* ===========================
   Make modal (アート送信：8秒に1回、低画質JPEG)
   + 消しゴムの背景消しバグ修正（export時はbg色で上書き）
=========================== */
let currentMakingOrder = null;
let espDone=false, milkDone=false;
let artStrokes = [];
let currentStroke = null;
let drawing = false;
let savedArtDataUrl = null;
let lastCookingPreviewSentAt = 0;
let cookingPreviewDirty = false;
let cookingPreviewTimer = null;

function latteClear(){
  latteCtx.clearRect(0,0,latteCanvas.width,latteCanvas.height);
  latteCtx.fillStyle='#6b3b24';
  latteCtx.beginPath(); latteCtx.arc(60,60,58,0,Math.PI*2); latteCtx.fill();
}
function latteFillEsp(){ latteCtx.fillStyle='#5a2f1a'; latteCtx.fillRect(0,60,latteCanvas.width,60); }
function latteFillMilk(){ latteCtx.fillStyle='#f6efe6'; latteCtx.beginPath(); latteCtx.arc(60,60,48,0,Math.PI*2); latteCtx.fill(); }

function initArtCanvas(bg){
  artBgCtx.clearRect(0,0,artBg.width,artBg.height);
  const bgc = bg || artBgColor.value || '#6b3b24';
  artBgCtx.fillStyle = bgc;
  artBgCtx.beginPath(); artBgCtx.arc(120,120,100,0,Math.PI*2); artBgCtx.fill();

  // 白縁（黒縁→白へ）
  artBgCtx.strokeStyle = '#ffffff';
  artBgCtx.lineWidth = 6;
  artBgCtx.beginPath(); artBgCtx.arc(120,120,100,0,Math.PI*2); artBgCtx.stroke();

  artLayerCtx.clearRect(0,0,artLayer.width,artLayer.height);
  artLayerCtx.lineCap='round'; artLayerCtx.lineJoin='round';
}

function getEventPos(e, canvas){
  const r = canvas.getBoundingClientRect();
  const t = e.touches ? e.touches[0] : null;
  const cx = t ? t.clientX : e.clientX;
  const cy = t ? t.clientY : e.clientY;
  return { x: (cx - r.left) * (canvas.width / r.width), y: (cy - r.top) * (canvas.height / r.height) };
}
function norm(p, canvas){ return { x: p.x / canvas.width, y: p.y / canvas.height }; }
function denorm(p, canvas){ return { x: (p.x||0)*canvas.width, y: (p.y||0)*canvas.height }; }

/* live描画：消しゴムは layer のみ destination-out（背景は消えない） */
function drawSegment(ctx, stroke, canvas, p1, p2){
  if (stroke.tool === 'draw'){
    ctx.globalCompositeOperation='source-over';
    ctx.strokeStyle = stroke.pen;
  }else{
    ctx.globalCompositeOperation='destination-out';
    ctx.strokeStyle = '#000';
  }
  ctx.lineWidth = stroke.width;
  ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke();
  ctx.globalCompositeOperation='source-over';
}

artLayer.addEventListener('mousedown', (e)=>{
  drawing = true;
  const p = getEventPos(e, artLayer);
  currentStroke = {
    tool: penMode.value,
    width: parseInt(penSize.value,10),
    pen: artPenColor.value || '#ffffff',
    points: [ norm(p, artLayer) ],
  };
});
artLayer.addEventListener('mousemove', (e)=>{
  if (!drawing || !currentStroke) return;
  const p = getEventPos(e, artLayer);
  currentStroke.points.push(norm(p, artLayer));
  const pts = currentStroke.points;
  if (pts.length < 2) return;
  const p1 = denorm(pts[pts.length-2], artLayer);
  const p2 = denorm(pts[pts.length-1], artLayer);
  drawSegment(artLayerCtx, currentStroke, artLayer, p1, p2);

  // cooking preview: dirty
  cookingPreviewDirty = true;
});
function endStroke(){
  if (!drawing) return;
  drawing = false;
  if (currentStroke){
    artStrokes.push(currentStroke);
    currentStroke = null;
    saveArt.disabled = !(artStrokes.length);
    updateTaskStatus();
    cookingPreviewDirty = true;
  }
}
artLayer.addEventListener('mouseup', endStroke);
artLayer.addEventListener('mouseleave', endStroke);
artLayer.addEventListener('touchstart', (e)=>{ e.preventDefault(); artLayer.dispatchEvent(new MouseEvent('mousedown',{clientX:e.touches[0].clientX,clientY:e.touches[0].clientY})); }, {passive:false});
artLayer.addEventListener('touchmove', (e)=>{ e.preventDefault(); artLayer.dispatchEvent(new MouseEvent('mousemove',{clientX:e.touches[0].clientX,clientY:e.touches[0].clientY})); }, {passive:false});
artLayer.addEventListener('touchend', (e)=>{ e.preventDefault(); artLayer.dispatchEvent(new MouseEvent('mouseup')); }, {passive:false});

clearArt.onclick = ()=>{
  initArtCanvas(artBgColor.value);
  artStrokes = [];
  savedArtDataUrl = null;
  saveArt.disabled = true;
  updateTaskStatus();
  cookingPreviewDirty = true;
};

/* export（バグ修正）：erase は「透明に抜く」ではなく、BG色で描き戻す */
function exportArtDataUrl(scale=1, jpeg=false){
  const tmp = document.createElement('canvas');
  tmp.width = artLayer.width * scale;
  tmp.height = artLayer.height * scale;
  const ctx = tmp.getContext('2d');

  // 背景（円 + 白縁）
  const bgc = artBgColor.value || '#6b3b24';
  ctx.fillStyle = '#0000';
  ctx.clearRect(0,0,tmp.width,tmp.height);

  ctx.fillStyle = bgc;
  ctx.beginPath();
  ctx.arc(tmp.width/2, tmp.height/2, (100/240)*tmp.width, 0, Math.PI*2);
  ctx.fill();
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth = 6 * scale;
  ctx.beginPath();
  ctx.arc(tmp.width/2, tmp.height/2, (100/240)*tmp.width, 0, Math.PI*2);
  ctx.stroke();

  ctx.lineCap='round'; ctx.lineJoin='round';
  for (const s of artStrokes){
    const pts = s.points || [];
    if (pts.length < 2) continue;
    ctx.beginPath();
    ctx.lineWidth = (s.width || 6) * scale;
    if (s.tool === 'draw'){
      ctx.globalCompositeOperation='source-over';
      ctx.strokeStyle = s.pen || '#fff';
    }else{
      // erase: 背景色で上書き（背景が“消えた”ように見えるバグを防ぐ）
      ctx.globalCompositeOperation='source-over';
      ctx.strokeStyle = bgc;
    }
    for (let i=0;i<pts.length;i++){
      const p = pts[i];
      const x = p.x * tmp.width;
      const y = p.y * tmp.height;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }
  ctx.globalCompositeOperation='source-over';
  if (jpeg){
    return tmp.toDataURL('image/jpeg', 0.45); // 低画質
  }
  return tmp.toDataURL('image/png');
}

saveArt.onclick = ()=>{
  if (!artStrokes.length){ alert('アートがありません'); return; }
  savedArtDataUrl = exportArtDataUrl(2, false);
  saveArt.disabled = true;
  updateTaskStatus();
  alert('アートを保存しました。');
};

function updateTaskStatus(){
  const parts=[];
  if (!espDone || !milkDone) parts.push('注ぎ');
  if (!savedArtDataUrl && !artStrokes.length) parts.push('アート');
  taskStatusSmall.textContent = parts.length ? '未完了: ' + parts.join(' / ') : 'すべて完了';
  completeMake.disabled = parts.length !== 0;
}

/* 注ぎ：簡易 */
let espInterval=null, milkInterval=null;
function resetPour(){
  if (espInterval){ clearInterval(espInterval); espInterval=null; }
  if (milkInterval){ clearInterval(milkInterval); milkInterval=null; }
  espDone=false; milkDone=false;
  espBar.style.width='0%'; milkBar.style.width='0%';
  espPct.textContent='0%'; milkPct.textContent='0%';
  startEsp.disabled=false; startMilk.disabled=true;
  latteClear();
  updateTaskStatus();
}
function startAuto(barEl, pctEl, onOverflow){
  let pct=0;
  const it=setInterval(()=>{
    pct = Math.min(130, pct + Math.random()*4 + 1);
    barEl.style.width = pct + '%';
    pctEl.textContent = Math.round(pct) + '%';
    if (pct >= 120){ clearInterval(it); onOverflow(); }
  }, 100);
  return { it, get: ()=>pct };
}
startEsp.addEventListener('mousedown', ()=>{
  if (espInterval) return;
  startEsp.textContent='注ぎ中...';
  const r = startAuto(espBar, espPct, ()=>{ alert('注ぎ過ぎ（120%）最初から'); resetPour(); });
  espInterval = r.it;
});
startEsp.addEventListener('mouseup', ()=>{
  if (espInterval){ clearInterval(espInterval); espInterval=null; }
  startEsp.textContent='注ぐ（押し続け）';
  const pct = parseFloat(espBar.style.width)||0;
  if (pct>=95 && pct<=105){ espDone=true; latteFillEsp(); startMilk.disabled=false; updateTaskStatus(); }
  else { alert('合格ライン外。最初から'); resetPour(); }
});
startMilk.addEventListener('mousedown', ()=>{
  if (milkInterval) return;
  startMilk.textContent='注ぎ中...';
  const r = startAuto(milkBar, milkPct, ()=>{ alert('注ぎ過ぎ（120%）最初から'); resetPour(); });
  milkInterval = r.it;
});
startMilk.addEventListener('mouseup', ()=>{
  if (milkInterval){ clearInterval(milkInterval); milkInterval=null; }
  startMilk.textContent='注ぐ（押し続け）';
  const pct = parseFloat(milkBar.style.width)||0;
  if (pct>=95 && pct<=105){ milkDone=true; latteFillMilk(); updateTaskStatus(); }
  else { alert('合格ライン外。最初から'); resetPour(); }
});
startEsp.addEventListener('touchstart',(e)=>{ e.preventDefault(); startEsp.dispatchEvent(new Event('mousedown')); }, {passive:false});
startEsp.addEventListener('touchend',(e)=>{ e.preventDefault(); startEsp.dispatchEvent(new Event('mouseup')); }, {passive:false});
startMilk.addEventListener('touchstart',(e)=>{ e.preventDefault(); startMilk.dispatchEvent(new Event('mousedown')); }, {passive:false});
startMilk.addEventListener('touchend',(e)=>{ e.preventDefault(); startMilk.dispatchEvent(new Event('mouseup')); }, {passive:false});

/* make modal open */
async function openMakeModal(order){
  currentMakingOrder = order;
  makerName.textContent = order.assignedToName || order.assignedTo || '';
  const cfg = MENUS[order.menuId] || MENUS.rate;
  makeTitle.textContent = `${cfg.ui?.makeTitle || '制作'}（担当：${makerName.textContent}）`;
  espressoLabel.textContent = cfg.ui?.step1 || '工程①';
  milkLabel.textContent = cfg.ui?.step2 || '工程②';
  artBgColor.value = cfg.artBg || '#6b3b24';
  artPenColor.value = cfg.artPen || '#ffffff';

  resetPour();
  initArtCanvas(artBgColor.value);
  artStrokes = [];
  savedArtDataUrl = null;
  saveArt.disabled = true;

  show(modalMake);
  updateTaskStatus();

  // cooking preview send loop
  if (cookingPreviewTimer) clearInterval(cookingPreviewTimer);
  lastCookingPreviewSentAt = 0;
  cookingPreviewDirty = false;
  cookingPreviewTimer = setInterval(()=> maybeSendCookingPreview(), 500);
}

/* 8秒に1回、dirtyなら送る */
async function maybeSendCookingPreview(){
  if (!db) return;
  if (!currentMakingOrder) return;
  if (!cookingPreviewDirty) return;
  const now = Date.now();
  if (now - lastCookingPreviewSentAt < 8000) return;

  cookingPreviewDirty = false;
  lastCookingPreviewSentAt = now;

  // 低画質JPEG（scale 0.7）
  const previewUrl = exportArtDataUrl(1, true);
  try{
    await updateDoc(doc(db,'shops',state.currentShopId,'orders',currentMakingOrder.id), { cookingPreview: previewUrl, cookingPreviewAt: now });
  }catch(e){
    console.warn('send cooking preview failed', e);
  }
}

cancelMake.onclick = ()=>{
  hide(modalMake);
  currentMakingOrder = null;
  if (cookingPreviewTimer){ clearInterval(cookingPreviewTimer); cookingPreviewTimer=null; }
  try{ audioCookbgm.pause(); audioCookbgm.currentTime=0; }catch(e){}
};

/* complete make: delivered */
completeMake.onclick = async ()=>{
  if (!currentMakingOrder) return;
  // served image compose（簡易：アート+ラテ）
  const tmp = document.createElement('canvas');
  tmp.width = 1200; tmp.height = 1200;
  const t = tmp.getContext('2d');
  t.fillStyle = '#fff8ef'; t.fillRect(0,0,tmp.width,tmp.height);

  // ラテ
  t.drawImage(latteCanvas, 450,320,300,300);

  // アート
  const artUrl = savedArtDataUrl || exportArtDataUrl(2,false);
  const artImg = new Image();
  artImg.src = artUrl;
  await new Promise(r=>{ artImg.onload=r; artImg.onerror=r; });
  t.drawImage(artImg, 430,140,340,340);

  const servedUrl = tmp.toDataURL('image/png');

  try{
    if (db){
      await updateDoc(doc(db,'shops',state.currentShopId,'orders',currentMakingOrder.id), {
        state:'delivered',
        deliveredAt: Date.now(),
        servedImageData: servedUrl,
        artDataUrl: artUrl,
        cookingPreview: null
      });
      // 担当を待機に戻す（任意）
      const staffId = state.currentUser.staffId;
      if (staffId){
        await updateDoc(doc(db,'shops',state.currentShopId,'staffs',staffId), { status:'idle', onShift:true }).catch(()=>{});
      }
    }else{
      const o = state.orders.find(x=>x.id===currentMakingOrder.id);
      if (o){ o.state='delivered'; o.servedImageData=servedUrl; o.artDataUrl=artUrl; }
    }
    hide(modalMake);
    currentMakingOrder = null;
    if (cookingPreviewTimer){ clearInterval(cookingPreviewTimer); cookingPreviewTimer=null; }
    try{ audioCookbgm.pause(); audioCookbgm.currentTime=0; }catch(e){}
    alert('提供しました');
  }catch(e){
    console.warn(e);
    alert('提供に失敗しました');
  }
};

/* ===========================
   Client overlay (待機/料理中 → 画像表示)
   - 待機/料理中中にランダム口コミを小さく表示
=========================== */
function pickRandomReview(menuId){
  const pool = (state.reviews||[]).filter(r=>r.menuId===menuId && (r.text||'').trim().length);
  if (!pool.length) return null;
  return pool[Math.floor(Math.random()*pool.length)];
}
function showClientStatus(main, sub){
  orderStatusMain.textContent = main || '状態';
  orderStatusSub.textContent = sub || 'しばらくお待ちください';
  cookPreviewImg.src = ''; // まだ無い
  overlayReviewMini.style.display = 'none';
  overlayBusyText.textContent = '';
  orderStatusOverlay.style.display = 'flex';
  orderStatusOverlay.setAttribute('aria-hidden','false');
}
function hideClientStatus(){
  orderStatusOverlay.style.display = 'none';
  orderStatusOverlay.setAttribute('aria-hidden','true');
}
function updateClientOverlay(){
  if (!state.currentOrderIdForClient) return;
  const o = state.orders.find(x=>x.id===state.currentOrderIdForClient);
  if (!o) return;

  const pending = (state.orders||[]).filter(x=>x.state==='waiting' || x.state==='inprogress').length;
  overlayBusyText.textContent = `混雑: ${pending}件`;

  const rv = pickRandomReview(o.menuId);
  if (rv){
    overlayReviewMini.style.display = 'block';
    overlayReviewText.textContent = rv.text;
    overlayReviewStars.textContent = starString(rv.stars || 0);
  }else{
    overlayReviewMini.style.display = 'none';
  }

  if (o.state === 'waiting'){
    showClientStatus('現在対応待ち中', '店員さんが対応します');
    cookPreviewImg.src = o.cookingPreview || '';
  }else if (o.state === 'inprogress'){
    showClientStatus('現在調理中…', 'アートが更新されることがあります');
    // 画像中心
    if (o.cookingPreview){
      cookPreviewImg.src = o.cookingPreview;
    }
    // 調理BGM（PC/スマホどっちでも）
    try{ audioCookbgm.currentTime=0; audioCookbgm.play().catch(()=>{}); }catch(e){}
  }else if (o.state === 'delivered'){
    hideClientStatus();
    try{ audioCookbgm.pause(); audioCookbgm.currentTime=0; }catch(e){}
    showClientServed(o);
  }
}

/* ===========================
   Eat modal + save image fix (つぶれ防止：アスペクト維持)
   + 提供時：スマホならバイブ + ps.mp3
=========================== */
async function preloadFrames(basePath, frameCount=6){
  const frames = [];
  for (let i=1;i<=frameCount;i++){
    const variants = [
      `${basePath}${i}.png`,
      `${basePath}${String(i).padStart(2,'0')}.png`,
      `${basePath}_${i}.png`,
      `${basePath}_${String(i).padStart(2,'0')}.png`
    ];
    for (const v of variants){
      try{
        const url = getAssetUrl(v);
        const res = await fetch(url);
        if (!res.ok) continue;
        const blob = await res.blob();
        frames.push(URL.createObjectURL(blob));
        break;
      }catch(e){}
    }
  }
  return frames;
}

function fitDraw(ctx, img, x, y, w, h){
  const iw = img.naturalWidth || img.width;
  const ih = img.naturalHeight || img.height;
  if (!iw || !ih){
    ctx.drawImage(img, x, y, w, h);
    return;
  }
  const ir = iw/ih;
  const tr = w/h;
  let dw=w, dh=h, dx=x, dy=y;
  if (ir > tr){
    dh = h;
    dw = h * ir;
    dx = x - (dw-w)/2;
  }else{
    dw = w;
    dh = w / ir;
    dy = y - (dh-h)/2;
  }
  ctx.drawImage(img, dx, dy, dw, dh);
}

async function showClientServed(order){
  // 提供時：振動+ps.mp3
  try{
    if (navigator.vibrate) navigator.vibrate([120,60,120]);
  }catch(e){}
  try{
    audioPs.currentTime=0;
    audioPs.play().catch(()=>{});
  }catch(e){}

  const cfg = MENUS[order.menuId] || MENUS.rate;
  // 最初は合成画像 or 1枚目
  if (order.servedImageData){
    servedImage.src = order.servedImageData;
  }else{
    servedImage.src = getAssetUrl(cfg.imageBase + '1.png');
  }

  // アートミニ表示
  const ctx = servedArtMini.getContext('2d');
  ctx.clearRect(0,0,servedArtMini.width,servedArtMini.height);
  ctx.fillStyle = order.artBg || cfg.artBg || '#6b3b24';
  ctx.fillRect(0,0,servedArtMini.width,servedArtMini.height);
  if (order.artDataUrl){
    const img = new Image();
    img.src = order.artDataUrl;
    await new Promise(r=>{ img.onload=r; img.onerror=r; });
    fitDraw(ctx, img, 0,0,servedArtMini.width,servedArtMini.height);
  }

  // POMODORO復活：メニュー画像クリックで開く
  POMO.currentMenuKey = order.menuId || 'rate';
  modalEat.style.display='flex';
  modalEat.setAttribute('aria-hidden','false');

  // フレーム列（0だけになる問題回避：必ず1..nで読む）
  const frames = await preloadFrames(cfg.imageBase, cfg.frameCount || 6);
  if (frames.length){
    servedImage.src = frames[0];
    POMO.frames = frames;
    POMO.frameCount = frames.length;
  }else{
    POMO.frames = [];
    POMO.frameCount = cfg.frameCount || 6;
  }

  // 口コミ入力初期化
  reviewText.value = '';
  setStars(0);
}

/* 保存（つぶれ防止） */
saveAllBtn.onclick = ()=>{
  const tmp = document.createElement('canvas');
  tmp.width = 1200; tmp.height = 1200;
  const t = tmp.getContext('2d');
  t.fillStyle = '#fff8ef'; t.fillRect(0,0,tmp.width,tmp.height);

  const mainImg = new Image();
  mainImg.crossOrigin='anonymous';
  mainImg.src = servedImage.src;
  mainImg.onload = ()=>{
    // メインはfit
    fitDraw(t, mainImg, 120, 120, 960, 640);
    // アートミニ
    t.drawImage(servedArtMini, 860, 120, 220, 220);

    const a = document.createElement('a');
    a.href = tmp.toDataURL('image/png');
    a.download = 'served_save.png';
    a.click();
  };
  mainImg.onerror = ()=> alert('画像の読み込みに失敗しました');
};

/* ホームへ */
homeFromEat.onclick = ()=>{
  modalEat.style.display='none';
  modalEat.setAttribute('aria-hidden','true');
};

/* ===========================
   Reviews (星 + テキスト)
=========================== */
let pickedStars = 0;
function renderStarPicker(){
  reviewStarsPick.innerHTML='';
  for (let i=1;i<=5;i++){
    const b = document.createElement('button');
    b.className='mini-btn';
    b.style.padding='6px 10px';
    b.style.fontSize='14px';
    b.textContent = (i<=pickedStars) ? '★' : '☆';
    b.onclick = ()=> setStars(i);
    reviewStarsPick.appendChild(b);
  }
  reviewStarsValue.textContent = `${pickedStars}/5`;
}
function setStars(n){
  pickedStars = n;
  renderStarPicker();
}
renderStarPicker();

reviewCancel.onclick = ()=>{
  reviewText.value='';
  setStars(0);
};
reviewSubmit.onclick = async ()=>{
  if (!state.currentShopId || !state.currentMenuIdForClient){
    alert('先に注文してください');
    return;
  }
  const text = (reviewText.value||'').trim();
  const stars = pickedStars;
  if (!stars && !text){
    alert('星か文章を入れてください');
    return;
  }
  const payload = {
    menuId: state.currentMenuIdForClient,
    text,
    stars,
    createdAt: Date.now()
  };
  try{
    if (db){
      await addDoc(colReviews(), payload);

      // 平均値は簡易：menuStats を sum/count で更新（競合は小規模想定）
      try{
        const sref = docMenuStat(state.currentMenuIdForClient);
        const snap = await getDoc(sref);
        if (snap.exists()){
          const d = snap.data();
          const sum = (Number(d.sumStars)||0) + (Number(stars)||0);
          const count = (Number(d.count)||0) + 1;
          await updateDoc(sref, { sumStars: sum, count, avg: sum/count, updatedAt: Date.now() });
        }else{
          // create相当は updateDocだと失敗することがあるので、失敗してもOK（UIはstate.reviewsから計算）
        }
      }catch(e){}
    }else{
      state.reviews.unshift({ id:uid('r'), ...payload });
    }
    alert('投稿しました');
    reviewText.value='';
    setStars(0);
    // メニュー画面の星反映は次回メニュー表示でOK（今すぐ見たい場合は buildMenu 再作成でもOK）
  }catch(e){
    console.warn(e);
    alert('投稿に失敗しました');
  }
};

/* ===========================
   New menu offer + submissions
=========================== */
newMenuOfferBtn.onclick = ()=> show(modalNewMenuOffer);
newMenuNo.onclick = ()=> hide(modalNewMenuOffer);
newMenuYes.onclick = ()=>{
  hide(modalNewMenuOffer);
  openSubmissionPainter();
};

function initSubmitCanvas(){
  subBgCtx.clearRect(0,0,subBg.width,subBg.height);
  subBgCtx.fillStyle = subBgColor.value || '#fff2e6';
  subBgCtx.fillRect(0,0,subBg.width,subBg.height);
  // 白縁
  subBgCtx.strokeStyle = '#ffffff';
  subBgCtx.lineWidth = 6;
  subBgCtx.strokeRect(3,3,subBg.width-6,subBg.height-6);

  subLayerCtx.clearRect(0,0,subLayer.width,subLayer.height);
  subLayerCtx.lineCap='round'; subLayerCtx.lineJoin='round';
}

let subStrokes=[], subCur=null, subDrawing=false;

function subDrawSeg(stroke){
  const pts = stroke.points;
  if (pts.length<2) return;
  const p1 = denorm(pts[pts.length-2], subLayer);
  const p2 = denorm(pts[pts.length-1], subLayer);
  if (stroke.tool==='draw'){
    subLayerCtx.globalCompositeOperation='source-over';
    subLayerCtx.strokeStyle=stroke.pen;
  }else{
    subLayerCtx.globalCompositeOperation='destination-out';
    subLayerCtx.strokeStyle='#000';
  }
  subLayerCtx.lineWidth=stroke.width;
  subLayerCtx.beginPath(); subLayerCtx.moveTo(p1.x,p1.y); subLayerCtx.lineTo(p2.x,p2.y); subLayerCtx.stroke();
  subLayerCtx.globalCompositeOperation='source-over';
}

subLayer.addEventListener('mousedown',(e)=>{
  subDrawing=true;
  const p = getEventPos(e, subLayer);
  subCur = { tool: subMode.value, width:parseInt(subSize.value,10), pen: subPenColor.value || '#000', points:[ norm(p, subLayer) ] };
});
subLayer.addEventListener('mousemove',(e)=>{
  if (!subDrawing || !subCur) return;
  const p = getEventPos(e, subLayer);
  subCur.points.push(norm(p, subLayer));
  subDrawSeg(subCur);
});
function subEnd(){
  if (!subDrawing) return;
  subDrawing=false;
  if (subCur){ subStrokes.push(subCur); subCur=null; }
}
subLayer.addEventListener('mouseup', subEnd);
subLayer.addEventListener('mouseleave', subEnd);
subLayer.addEventListener('touchstart',(e)=>{ e.preventDefault(); subLayer.dispatchEvent(new MouseEvent('mousedown',{clientX:e.touches[0].clientX,clientY:e.touches[0].clientY})); }, {passive:false});
subLayer.addEventListener('touchmove',(e)=>{ e.preventDefault(); subLayer.dispatchEvent(new MouseEvent('mousemove',{clientX:e.touches[0].clientX,clientY:e.touches[0].clientY})); }, {passive:false});
subLayer.addEventListener('touchend',(e)=>{ e.preventDefault(); subLayer.dispatchEvent(new MouseEvent('mouseup')); }, {passive:false});

subClear.onclick = ()=>{
  initSubmitCanvas();
  subStrokes=[];
};
subBgColor.oninput = ()=> initSubmitCanvas();

function exportSubmissionJPEG(){
  const tmp = document.createElement('canvas');
  tmp.width = 640; tmp.height = 640;
  const ctx = tmp.getContext('2d');
  // bg
  ctx.fillStyle = subBgColor.value || '#fff2e6';
  ctx.fillRect(0,0,tmp.width,tmp.height);
  // replay strokes（eraseはbg色で上書き）
  ctx.lineCap='round'; ctx.lineJoin='round';
  const bgc = subBgColor.value || '#fff2e6';
  for (const s of subStrokes){
    const pts=s.points||[];
    if (pts.length<2) continue;
    ctx.beginPath();
    ctx.lineWidth = (s.width||6) * (tmp.width/subLayer.width);
    ctx.globalCompositeOperation='source-over';
    ctx.strokeStyle = (s.tool==='draw') ? (s.pen||'#000') : bgc;
    for (let i=0;i<pts.length;i++){
      const x = pts[i].x * tmp.width;
      const y = pts[i].y * tmp.height;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }
  return tmp.toDataURL('image/jpeg', 0.55);
}

function openSubmissionPainter(){
  if (!state.currentShopId){ alert('先にお店を選んでください'); return; }
  submitterName.value = '';
  subStrokes=[];
  initSubmitCanvas();
  show(modalSubmitMenu);
}

subBackHome.onclick = ()=> hide(modalSubmitMenu);

subSaveDraft.onclick = ()=>{
  const data = exportSubmissionJPEG();
  localStorage.setItem(`draft_${state.currentShopId}`, JSON.stringify({ name: submitterName.value||'', data, ts: Date.now() }));
  alert('下書きを保存しました');
};

subSubmit.onclick = async ()=>{
  if (!subStrokes.length){
    if (!confirm('何も描かれていません。提出しますか？')) return;
  }
  const dataUrl = exportSubmissionJPEG();
  const payload = {
    name: (submitterName.value||'').trim() || '匿名',
    imageDataUrl: dataUrl,
    createdAt: Date.now()
  };
  try{
    if (db){
      await addDoc(colSubmissions(), payload);
    }else{
      state.submissions.unshift({ id:uid('sub'), ...payload });
      renderSubmissionList();
    }
    hide(modalSubmitMenu);
    alert('提出しました（スタッフ画面に表示されます）');
  }catch(e){
    console.warn(e);
    alert('提出に失敗しました');
  }
};

function renderSubmissionList(){
  submissionList.innerHTML = '';
  if (!state.submissions || !state.submissions.length){
    submissionList.textContent = 'まだありません';
    return;
  }
  state.submissions.forEach(s=>{
    const wrap = document.createElement('div');
    wrap.style.display='flex';
    wrap.style.alignItems='center';
    wrap.style.gap='10px';
    wrap.style.padding='10px 0';
    wrap.style.borderBottom='1px dashed #e6d0c6';

    const img = document.createElement('img');
    img.src = s.imageDataUrl;
    img.style.width='64px';
    img.style.height='64px';
    img.style.objectFit='cover';
    img.style.borderRadius='12px';
    img.style.border='1px solid #e6d0c6';

    const meta = document.createElement('div');
    meta.style.flex='1';
    const short = (s.id||'').slice(-4);
    meta.innerHTML = `<div style="font-weight:900;">#${escapeHtml(short)} ${escapeHtml(s.name||'')}</div>
                      <div class="small-info">${new Date(s.createdAt||0).toLocaleString()}</div>`;

    const dl = document.createElement('button');
    dl.className='mini-btn';
    dl.style.padding='6px 10px';
    dl.style.fontSize='12px';
    dl.textContent='画像保存';
    dl.onclick = ()=>{
      const a=document.createElement('a');
      a.href = s.imageDataUrl;
      a.download = `submission_${short}.jpg`;
      a.click();
    };

    const del = document.createElement('button');
    del.className='mini-btn danger';
    del.style.padding='6px 10px';
    del.style.fontSize='12px';
    del.textContent='消す';
    del.onclick = async ()=>{
      if (!confirm('消しますか？')) return;
      if (db){
        try{ await deleteDoc(doc(db,'shops',state.currentShopId,'submissions',s.id)); }catch(e){}
      }else{
        state.submissions = state.submissions.filter(x=>x.id!==s.id);
        renderSubmissionList();
      }
    };

    wrap.appendChild(img);
    wrap.appendChild(meta);
    wrap.appendChild(dl);
    wrap.appendChild(del);
    submissionList.appendChild(wrap);
  });
}

/* ===========================
   Bot produce (簡易)
   - cookingPreview も返す（低画質）
=========================== */
async function botProduce(menuItem, customerName){
  // cookingPreview: 低画質の仮画像
  const c = document.createElement('canvas'); c.width=240; c.height=240;
  const ctx = c.getContext('2d');
  ctx.fillStyle = menuItem.artBg || '#6b3b24'; ctx.fillRect(0,0,c.width,c.height);
  ctx.strokeStyle = '#fff'; ctx.lineWidth = 8; ctx.strokeRect(4,4,c.width-8,c.height-8);
  ctx.fillStyle = '#fff';
  ctx.font = '20px sans-serif';
  ctx.textAlign='center';
  ctx.fillText('料理中...', 120, 120);
  const cookingPreview = c.toDataURL('image/jpeg', 0.45);

  // served image
  const tmp = document.createElement('canvas'); tmp.width=1200; tmp.height=1200;
  const t = tmp.getContext('2d');
  t.fillStyle='#fff8ef'; t.fillRect(0,0,tmp.width,tmp.height);

  // circle
  t.fillStyle = menuItem.artBg || '#6b3b24';
  t.beginPath(); t.arc(600,400,180,0,Math.PI*2); t.fill();
  t.strokeStyle='#fff'; t.lineWidth=10; t.beginPath(); t.arc(600,400,180,0,Math.PI*2); t.stroke();

  // card
  const card = document.createElement('canvas'); card.width=520; card.height=240;
  const cctx = card.getContext('2d');
  cctx.fillStyle = '#fff2e6'; cctx.fillRect(0,0,card.width,card.height);
  cctx.strokeStyle = '#d4c0b8'; cctx.lineWidth = 4; cctx.strokeRect(8,8,card.width-16,card.height-16);
  cctx.fillStyle = '#000'; cctx.textAlign='center';
  cctx.font='28px sans-serif'; cctx.fillText('どうぞ', card.width/2, 70);
  cctx.font='22px sans-serif'; cctx.fillText('ごゆっくり～☕', card.width/2, 110);
  cctx.font='28px sans-serif'; cctx.fillText((customerName||'名無し')+'さん', card.width/2, 160);

  const cardUrl = card.toDataURL('image/png');
  const cardImg = new Image(); cardImg.src = cardUrl;
  await new Promise(r=>{ cardImg.onload=r; cardImg.onerror=r; });
  t.drawImage(cardImg, 430,720,340,160);

  const servedImageData = tmp.toDataURL('image/png');
  return { servedImageData, artDataUrl: null, cookingPreview };
}

/* ===========================
   Pomodoro (復活 + 画像フレーム操作)
   - “0だけ表示”問題を避ける：frames があればそれを使う
=========================== */
const POMO = {
  running:false, phase:'idle',
  loopTotal:2, loopIndex:0,
  workMin:1, breakMin:5,
  remainingMs:0, tick:null, lastTs:0,
  currentMenuKey:'rate',
  frames:[],
  frameCount:6,
};
function formatTime(ms){
  if (ms<0) ms=0;
  let s=Math.floor(ms/1000);
  const h=Math.floor(s/3600); s=s%3600;
  const m=Math.floor(s/60); const sec=s%60;
  return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
}
function updatePomoCountDisplay(){
  const loops = Math.max(1, Math.min(10, parseInt(loopCountInput.value||'1')));
  pomoCountDisplay.textContent = `${loops} / ${loops}`;
}
function wireHold(btn, input, delta, min, max){
  let t=null, start=0;
  function step(){
    let v=parseInt(input.value||'0'); v+=delta;
    if (min!=null) v=Math.max(min,v);
    if (max!=null) v=Math.min(max,v);
    input.value=v;
    updatePomoCountDisplay();
  }
  function begin(){
    start=Date.now();
    step();
    let interval=500;
    t=setTimeout(function rep(){
      const held=Date.now()-start;
      const k=Math.min(1, held/2000);
      interval=Math.max(80, Math.floor(500-(420*k)));
      step();
      t=setTimeout(rep, interval);
    }, interval);
  }
  function end(){ if (t){ clearTimeout(t); t=null; } }
  btn.addEventListener('mousedown',(e)=>{ e.preventDefault(); begin(); });
  btn.addEventListener('touchstart',(e)=>{ e.preventDefault(); begin(); }, {passive:false});
  window.addEventListener('mouseup', end);
  window.addEventListener('touchend', end);
  btn.addEventListener('click',(e)=>{ e.preventDefault(); step(); });
}
wireHold(loopUp, loopCountInput, +1, 1, 10);
wireHold(loopDown, loopCountInput, -1, 1, 10);
wireHold(workUp, workMinInput, +1, 1, 200);
wireHold(workDown, workMinInput, -1, 1, 200);
wireHold(breakUp, breakMinInput, +1, 1, 200);
wireHold(breakDown, breakMinInput, -1, 1, 200);
updatePomoCountDisplay();

function setServedFrameByProgress(){
  // frames があるなら、進捗で 2..end を出す（0のような表示を避ける）
  if (!POMO.frames || !POMO.frames.length) return;
  if (POMO.phase !== 'work') return;
  const total = POMO.workMin*60*1000;
  const elapsed = Math.max(0, total - POMO.remainingMs);
  const ratio = Math.min(1, Math.max(0, elapsed/total));
  const from = Math.min(1, POMO.frames.length-1) ? 1 : 0;
  const to = POMO.frames.length-1;
  const idx = Math.min(to, Math.max(0, Math.floor(from + (to-from)*ratio)));
  servedImage.src = POMO.frames[idx] || servedImage.src;
}

function renderPomoUI(){
  if (!POMO.running){
    pomoSettings.style.display='block';
    pomoRunning.style.display='none';
    eatSoundInfo.textContent='↑ 画像クリックでタイマー';
    pomoProgressBar.style.width='0%';
    return;
  }
  pomoSettings.style.display='none';
  pomoRunning.style.display='block';
  pomoLoopCounter.textContent = `${POMO.loopIndex+1} / ${POMO.loopTotal}`;
  pomoPhaseLabel.textContent = (POMO.phase==='work')?'作業中':(POMO.phase==='break')?'休憩中':'一時停止';
  pomoTimerText.textContent = formatTime(POMO.remainingMs);

  const total = (POMO.phase==='work'?POMO.workMin:POMO.breakMin)*60*1000;
  const elapsed = Math.max(0, total - POMO.remainingMs);
  const pct = Math.min(100, Math.floor(elapsed/total*100));
  pomoProgressBar.style.width = pct + '%';
}

function startTick(){
  if (POMO.tick) return;
  POMO.lastTs = Date.now();
  POMO.tick = setInterval(()=>{
    if (!POMO.running) return;
    const now = Date.now();
    const dt = now - POMO.lastTs;
    POMO.lastTs = now;
    if (POMO.phase==='paused') return;

    POMO.remainingMs -= dt;
    if (POMO.remainingMs <= 0){
      if (POMO.phase==='work'){
        POMO.phase='break';
        POMO.remainingMs = POMO.breakMin*60*1000;
        // 休憩：最後の方のフレームに寄せる
        if (POMO.frames && POMO.frames.length) servedImage.src = POMO.frames[POMO.frames.length-1];
      }else if (POMO.phase==='break'){
        POMO.loopIndex++;
        if (POMO.loopIndex >= POMO.loopTotal){
          stopPomo(true);
          return;
        }else{
          POMO.phase='work';
          POMO.remainingMs = POMO.workMin*60*1000;
          if (POMO.frames && POMO.frames.length) servedImage.src = POMO.frames[0];
        }
      }
    }else{
      setServedFrameByProgress();
    }
    renderPomoUI();
  }, 250);
}
function stopTick(){ if (POMO.tick){ clearInterval(POMO.tick); POMO.tick=null; } }

function startPomo(){
  POMO.loopTotal = Math.max(1, Math.min(10, parseInt(loopCountInput.value||'1')));
  POMO.workMin = Math.max(1, Math.min(200, parseInt(workMinInput.value||'25')));
  POMO.breakMin = Math.max(1, Math.min(200, parseInt(breakMinInput.value||'5')));
  POMO.loopIndex = 0;
  POMO.running = true;
  POMO.phase = 'work';
  POMO.remainingMs = POMO.workMin*60*1000;
  startTick();
  renderPomoUI();
}
function stopPomo(toSettings){
  POMO.running=false;
  POMO.phase='idle';
  POMO.remainingMs=0;
  stopTick();
  if (toSettings){
    pomoSettings.style.display='block';
    pomoRunning.style.display='none';
  }
  renderPomoUI();
}
function togglePause(){
  if (!POMO.running) return;
  if (POMO.phase==='paused'){
    POMO.phase = POMO._prev || 'work';
  }else{
    POMO._prev = POMO.phase;
    POMO.phase='paused';
  }
  renderPomoUI();
}
function skipPhase(){
  if (!POMO.running) return;
  POMO.remainingMs = 0;
}

startPomoBtn.onclick = ()=> startPomo();
stopPomoBtn.onclick = ()=> stopPomo(true);
pausePomoBtn.onclick = ()=> togglePause();
skipPomoBtn.onclick = ()=> skipPhase();

/* 画像クリックで開く（復活） */
servedImage.addEventListener('click', ()=>{
  pomodoroPanel.classList.add('show');
});
/* 外クリックで閉じる（動作中は閉じない） */
document.addEventListener('click',(e)=>{
  if (!pomodoroPanel.contains(e.target) && e.target !== servedImage){
    if (!POMO.running){
      pomodoroPanel.classList.remove('show');
    }
  }
});

/* ===========================
   Init
=========================== */
function initHome(){
  // 初期は店選択
  shopPicker.style.display='flex';
  homePanel.style.display='none';
  headerTitle.textContent = '仮想飲食';
  miniShop.textContent = '未選択';
  renderShopPicker();
}
initHome();

/* 店選択後に表示が更新されないケース用：短いポーリング */
setInterval(()=>{
  if (state.currentShopId){
    renderShiftShort();
    updateOrderButtonState();
    renderBusy();
  }
}, 1500);

/* 調理プレビューが無い時の表示 */
cookPreviewImg.alt = '調理中のアート（更新されます）';
cookPreviewImg.src = '';

/* 初期：音声はブラウザ制限があるので、最初のユーザー操作でアンロックだけしておく */
document.body.addEventListener('click', ()=>{
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    ctx.resume && ctx.resume();
    ctx.close && ctx.close();
  }catch(e){}
}, { once:true });

</script>

</body>
</html>
