<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>仮想飲食システム（マルチ店舗版）</title>
<meta name="format-detection" content="telephone=no">
<style>
  :root{
    --bg:#f7efe7; --accent:#b33; --paper:#fff8ef; --dark:#3a2b20; --muted:#8b6d5c;
    --card-skin:#fff2e6;
  }
  html,body{height:100%;margin:0;font-family:"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:url("https://raw.githubusercontent.com/zzcafe2800/reiji_cafe/main/3739270_l.jpg") center center / cover no-repeat;}
  body{min-height:100vh;display:flex;align-items:center;justify-content:center;}

  .container{width:100%;max-width:420px;margin:0;position:relative;perspective:2000px;aspect-ratio:3/5;}
  .book{position:relative;width:100%;height:100%;}
  .page{position:absolute;inset:0;width:100%;height:100%;overflow:hidden;}

  .inner{position:absolute;inset:0;background:url("https://raw.githubusercontent.com/zzcafe2800/reiji_cafe/main/menuh.png") center / cover no-repeat;
    box-shadow:0 6px 20px rgba(0,0,0,0.15);border-radius:10px;outline:6px solid var(--accent);outline-offset:-6px;
    z-index:1;display:flex;flex-direction:column;overflow:hidden;
  }
  header{display:flex;align-items:center;justify-content:space-between;padding:12px;color:var(--dark);}
  @media (min-width:768px){.container{width:94vw;margin:12px auto;aspect-ratio:3/5;}}

  .content{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:12px;}
  .order-block{width:100%;max-width:520px;display:flex;flex-direction:column;align-items:center;gap:10px;}
  .status-line{font-weight:700;background:rgba(255,255,255,0.92);padding:8px 12px;border-radius:8px;border:2px solid #f0c6c6;text-align:center;}
  .order-row{width:100%;display:flex;gap:8px;align-items:stretch;justify-content:center;}
  .order-btn{
    background:linear-gradient(180deg,#ffd4c4,#ffb38a);border:4px solid var(--accent);color:var(--dark);
    padding:14px 18px;border-radius:12px;cursor:pointer;box-shadow:0 6px 0 #913;user-select:none;
    width:100%;max-width:160px;aspect-ratio:5/3;font-size:clamp(16px,4vw,30px);display:flex;align-items:center;justify-content:center;text-align:center;
  }
  .order-btn.disabled{opacity:0.4;cursor:not-allowed;box-shadow:none;}

  .small-pass{position:fixed;left:12px;bottom:12px;background:rgba(255,255,255,0.95);padding:6px;border-radius:6px;border:1px dashed #c66;display:flex;align-items:center;gap:6px;z-index:60;}
  .small-pass input{width:120px;padding:4px;}
  .guest-mini{position:fixed;right:12px;bottom:12px;background:var(--paper);padding:8px;border-radius:8px;border:1px solid #e6d6cc;font-size:13px;box-shadow:0 6px 12px rgba(0,0,0,0.08);}

  .staff-full{position:fixed;inset:0;background:linear-gradient(180deg,#fff8f2,#fff3ec);padding:18px;z-index:90;display:none;flex-direction:column;overflow:auto;}
  .staff-full.show{display:flex;}
  .staff-top{display:flex;justify-content:space-between;align-items:center;gap:8px;}
  .big-toggle{display:flex;gap:8px;align-items:center;margin-top:8px;}
  .big-toggle button{flex:1;padding:12px;border-radius:8px;font-size:16px;border:2px solid #c6b3b3;cursor:pointer;}
  .big-toggle .on{background:#2b8f4a;color:#fff;border-color:#2b8f4a;}
  .big-toggle .off{background:#f0f0f0;color:#666;}

  .staff-body{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;}
  .staff-panel{flex:1;min-width:280px;background:var(--paper);padding:12px;border-radius:8px;border:1px solid #e6d6cc;max-height:520px;overflow:auto;}
  .order-item{padding:8px;border-bottom:1px dashed #e6d0c6;display:flex;justify-content:space-between;align-items:center;gap:10px;}
  .small-info{font-size:12px;color:var(--muted);}
  .small{font-size:12px;padding:6px 10px;border-radius:8px;border:1px solid #d4c0b8;background:#fff;cursor:pointer;}
  .btn-red{background:#b33;color:#fff;border:1px solid #b33;}
  .btn-green{background:#2b8f4a;color:#fff;border:1px solid #2b8f4a;}

  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:100;}
  .modal{background:#fff;padding:16px;border-radius:10px;width:780px;max-width:95%;box-shadow:0 8px 30px rgba(0,0,0,0.4);border:6px solid var(--accent);}
  .menu-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
  .menu-item{padding:8px;border:2px solid #e0bdb5;background:#fff;border-radius:8px;text-align:center;cursor:pointer;position:relative;}
  img.menu-thumb{width:100%;height:120px;object-fit:cover;border-radius:6px;}
  .star-badge{position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.55);color:#fff;font-size:12px;padding:4px 6px;border-radius:8px;}

  .status-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:120;flex-direction:column;color:#111;padding:18px;}
  .status-card{width:92%;max-width:720px;background:rgba(255,255,255,0.98);padding:18px;border-radius:12px;border:4px solid var(--accent);text-align:center;font-size:22px;font-weight:800;}
  .status-sub{font-size:12px;color:#444;margin-top:8px;}
  .status-art{margin-top:12px;display:flex;justify-content:center;}
  .status-art img{width:min(360px,80vw);height:auto;border-radius:12px;border:2px solid #e6d0c6;box-shadow:0 8px 18px rgba(0,0,0,0.15);}
  .review-marquee{margin-top:10px;font-size:12px;color:#333;opacity:.9;}

  .sound-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:200;background:rgba(0,0,0,0.6);color:#fff;flex-direction:column;}
  .sound-panel{background:#fff;padding:18px;border-radius:12px;color:#111;border:3px solid var(--accent);width:360px;max-width:92%;text-align:center;}
  .bgm-btn{font-size:12px;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.95);border:1px solid #e6d0c6;cursor:pointer;}

  /* 店選択 */
  .store-pick{
    position:fixed; inset:0; z-index:300; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.55); padding:16px;
  }
  .store-pick .panel{
    width:min(560px,92vw); background:#fff; border-radius:14px; border:4px solid var(--accent);
    padding:14px; box-shadow:0 10px 30px rgba(0,0,0,0.25);
  }
  .store-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-bottom:1px dashed #e6d0c6;}
  .store-row:last-child{border-bottom:none;}
  .store-name{font-weight:800;color:#3a2b20;}
  .mini-link{font-size:12px;color:#555;text-decoration:underline;cursor:pointer;background:none;border:none;padding:0}

  /* 飲食モーダル（簡易） */
  #modalEat .modal{
    width:95%;max-width:980px;background:rgba(255,255,255,0.95);
    border-radius:14px;padding:14px;box-shadow:0 12px 30px rgba(0,0,0,0.25);
  }
  #eatMainWrap{width:100%;height:520px;border-radius:12px;background:#fffdf8;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;box-shadow:inset 0 0 12px rgba(0,0,0,.15);}
  #servedImage{max-width:100%;max-height:100%;border-radius:8px;}
  .side-card{background:rgba(255,255,255,.92);border-radius:12px;padding:10px;box-shadow:0 4px 12px rgba(0,0,0,.12);}
  .mini-frame{background:#fff;border:6px solid #e8dccd;border-bottom:10px solid #d7c6b2;border-radius:4px;padding:4px;box-shadow:0 4px 10px rgba(0,0,0,.15);}
  .review-box{margin-top:10px;border:1px solid #e6d0c6;border-radius:10px;padding:10px;background:#fff;}
  .stars{display:flex;gap:6px;font-size:18px;cursor:pointer;user-select:none;}
  .stars span{opacity:.35}
  .stars span.on{opacity:1}
  .review-box textarea{width:100%;height:70px;resize:none;border:1px solid #e6d0c6;border-radius:10px;padding:8px;font-family:inherit;}
</style>
</head>

<body>
<!-- 店選択 -->
<div id="storePick" class="store-pick">
  <div class="panel">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <div>
        <div style="font-weight:900;font-size:18px;">お店を選ぶ</div>
        <div class="small-info">来店するお店を選択してください</div>
      </div>
      <button id="storePickClose" class="small">閉じる</button>
    </div>
    <div id="storeList" style="margin-top:10px;"></div>
    <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;">
      <button id="makeMyStoreBtn" class="mini-link">自分のお店用を作りたい方</button>
      <button id="storePickBack" class="small">戻る</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="book">
    <div class="page inner">
      <header>
        <div>
          <h1 id="storeTitle" style="margin:0;font-size:16px;">--</h1>
          <div class="small-info">時刻: <span id="nowtime">--:--:--</span></div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button id="storeChangeBtn" class="bgm-btn" title="店変更">店</button>
          <button id="xBtn" class="bgm-btn" title="X">X</button>
        </div>
      </header>

      <div class="content">
        <div class="order-block">
          <div id="shiftShort" class="status-line">読み込み中...</div>
          <div class="order-row">
            <button id="orderBtn" class="order-btn disabled">注文</button>
          </div>
          <div id="helperSmall" class="small-info">実際の支払いはありません</div>
          <div id="crowdInfo" class="small-info"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="guest-mini" id="guestMini">
  <div id="guestRole"><strong>あなた：客</strong></div>
  <div class="small-info" style="margin-top:6px">目的：注文</div>
</div>

<div class="small-pass">
  <label style="font-size:12px;margin:0">店員用</label>
  <input id="staffPass" placeholder="店パス" />
  <button id="passOk" class="small">OK</button>
</div>

<!-- staff -->
<div id="staffFull" class="staff-full" aria-hidden="true">
  <div class="staff-top">
    <div>
      <strong id="staffBadge">店員</strong>
      <div class="small-info">店員控室</div>
      <div class="small-info">店：<span id="staffStoreName">--</span></div>
    </div>
    <div>
      <button id="logoutStaff" class="small">退室</button>
    </div>
  </div>

  <div style="margin-top:10px;">
    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
      <label>シフト開始</label><input id="shiftStart" type="time" />
      <label>終了</label><input id="shiftEnd" type="time" />
      <label>状況</label>
      <select id="staffStateSel">
        <option value="waiting">待機中</option>
        <option value="busy">他方の料理中</option>
      </select>
      <button id="saveShift" class="small">保存</button>
    </div>

    <div class="big-toggle" style="margin-top:10px;">
      <button id="shiftBtn" class="off">シフト中</button>
      <button id="breakBtn" class="off">休憩中</button>
    </div>

    <div style="margin-top:10px;background:#fff;padding:10px;border-radius:10px;border:1px solid #e6d0c6;">
      <div style="font-weight:800;">無人時の注文</div>
      <div class="small-info">※BOT機能はありません。OFFだとシフト0人の時は注文できません。</div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="emptyOrderOn" class="small">ON（注文できる）</button>
        <button id="emptyOrderOff" class="small">OFF（注文できない）</button>
        <div class="small-info" style="margin-left:auto;">現在: <span id="emptyOrderState">--</span></div>
      </div>
    </div>
  </div>

  <div class="staff-body">
    <div class="staff-panel">
      <strong>全員のシフト一覧</strong>
      <div id="shiftList" class="shift-list small-info" style="margin-top:8px">読み込み中…</div>
    </div>

    <div class="staff-panel">
      <strong>注文一覧 <span id="pendingTasksSmall" class="small-info"></span></strong>
      <div id="staffOrderList" class="order-list" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- sound overlay -->
<div id="soundOverlay" class="sound-overlay" style="display:none;">
  <div class="sound-panel">
    <h3>効果音など流しますか？</h3>
    <p style="font-size:12px;">音声、効果音が流れます</p>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
      <button id="enableSoundBtn" class="btn-green small">OK</button>
      <button id="disableSoundBtn" class="small">NO</button>
    </div>
  </div>
</div>

<!-- order status overlay (art realtime) -->
<div id="orderStatusOverlay" class="status-overlay">
  <div class="status-card">
    <div id="orderStatusMain">状態</div>
    <div id="orderStatusSub" class="status-sub">対応されない場合再度注文</div>
    <div class="status-art"><img id="statusArtImg" alt="" style="display:none;"></div>
    <div id="statusReview" class="review-marquee" style="display:none;"></div>
  </div>
</div>

<!-- name modal -->
<div id="modalName" class="modal-back" style="display:none;align-items:center;justify-content:center;">
  <div class="modal">
    <h3 id="nameModalTitle">ゲーム内の名前</h3>
    <input id="orderName" placeholder="名前を入力" style="width: 300px; height: 60px;" />
    <div style="margin-top:10px;text-align:right;">
      <button id="cancelOrderName" class="small">キャンセル</button>
      <button id="okOrderName" class="btn-red small">決定</button>
    </div>
  </div>
</div>

<!-- menu modal -->
<div id="modalMenu" class="modal-back" style="display:none;align-items:center;justify-content:center;">
  <div class="modal">
    <h3>メニューを選択『１日１品まで』</h3>
    <div class="menu-grid" id="menuGrid"></div>
    <div style="margin-top:10px;text-align:right;">
      <button id="backMenu" class="small">戻る</button>
    </div>
  </div>
</div>

<!-- make modal (art realtime send) -->
<div id="modalMake" class="modal-back" style="display:none;align-items:flex-start;overflow:auto;">
  <div class="modal" style="width:95%;max-width:960px;">
    <h3 id="makeTitle">制作（担当：<span id="makerName"></span>）</h3>

    <div style="display:flex;flex-wrap:wrap;gap:12px;">
      <div style="flex:1;min-width:320px;">
        <div style="background:#fff8ef;padding:10px;border-radius:10px;border:1px solid #e0c7bb;">
          <strong>アート（リアルタイム送信）</strong>
          <div class="small-info">※8秒に1回、変更があった時だけ軽量で送信</div>

          <div style="margin-top:8px;">
            <div style="position:relative;width:240px;height:240px;border-radius:10px;overflow:hidden;border:1px solid #d4c0b8;background:#b36e3c;">
              <canvas id="artBg" width="240" height="240" style="position:absolute;left:0;top:0;"></canvas>
              <canvas id="artLayer" width="240" height="240" style="position:absolute;left:0;top:0;"></canvas>
            </div>

            <div style="margin-top:8px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
              <label>ツール</label>
              <select id="penMode"><option value="draw">描く</option><option value="erase">消しゴム</option></select>
              <label>太さ</label>
              <select id="penSize"><option value="2">小</option><option value="6" selected>中</option><option value="12">大</option></select>
              <button id="clearArt" class="small">クリア</button>
              <label style="font-size:12px;">背景</label><input id="artBgColor" type="color" value="#6b3b24"/>
              <label style="font-size:12px;">ペン</label><input id="artPenColor" type="color" value="#ffffff"/>
            </div>

            <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;align-items:center;">
              <div id="rtState" class="small-info" style="margin-right:auto;"></div>
              <button id="saveArt" class="small btn-green">アート保存</button>
              <button id="deliverBtn" class="small btn-red">提供する</button>
              <button id="cancelMake" class="small">中止</button>
            </div>
          </div>
        </div>
      </div>

      <div style="flex:1;min-width:320px;">
        <div style="background:#fff;padding:10px;border-radius:10px;border:1px solid #e6d0c6;">
          <strong>現在の注文</strong>
          <div id="makeOrderInfo" class="small-info" style="margin-top:6px;"></div>
          <div style="margin-top:10px;">
            <strong>ランダム口コミ（参考表示）</strong>
            <div id="makeRandomReview" class="small-info" style="margin-top:6px;">--</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- eat modal -->
<div id="modalEat" class="modal-back" style="display:none;align-items:center;justify-content:center;">
  <div class="modal">
    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:420px;">
        <div id="eatMainWrap">
          <img id="servedImage" src="" alt="商品画像" />
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
          <button id="saveAllBtn" class="small">画像保存</button>
          <div id="eatRandomReview" class="small-info" style="margin-left:auto;"></div>
        </div>
      </div>

      <div style="width:340px;max-width:92vw;">
        <div class="side-card">
          <div style="display:flex;gap:8px;">
            <div class="mini-frame"><canvas id="servedArtMini" width="220" height="220"></canvas></div>
          </div>

          <div class="review-box">
            <div style="font-weight:900;">口コミ</div>
            <div class="small-info">※他の方に見られます</div>
            <div class="stars" id="reviewStars" aria-label="rating">
              <span data-n="1">☆</span><span data-n="2">☆</span><span data-n="3">☆</span><span data-n="4">☆</span><span data-n="5">☆</span>
            </div>
            <textarea id="reviewText" placeholder="対応や待ち時間など（他の方に見られます）"></textarea>
            <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px;">
              <button id="submitReviewBtn" class="small btn-green">送信</button>
            </div>
          </div>

          <div style="margin-top:10px;text-align:right;">
            <button id="homeFromEat" class="small">ホームへ</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
/* ===== Firebase imports ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  addDoc,
  updateDoc,
  deleteDoc,
  onSnapshot,
  query,
  orderBy,
  getDoc,
  setDoc,
  limit,
  where
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* ===== Firebase config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBJe7_PGeOEkCyC1NxaTMc5bjelQwv2OaU",
  authDomain: "insyoku-f9aee.firebaseapp.com",
  projectId: "insyoku-f9aee",
  storageBucket: "insyoku-f9aee.firebasestorage.app",
  messagingSenderId: "887841835344",
  appId: "1:887841835344:web:249470b39af256b8a34455",
  measurementId: "G-QET0N3KP2L"
};

let app, auth, db;
try {
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
  signInAnonymously(auth).catch(()=>{});
} catch(e){
  console.warn("Firebase init failed", e);
  db = null;
}

/* ===== Utils ===== */
function uid(p='id'){ return p + Math.random().toString(36).slice(2,9); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function getAssetUrl(path){
  if (!path) return '';
  if (path.startsWith('@')) return 'https://raw.githubusercontent.com/' + path.slice(1);
  try { return new URL(path).href; } catch(e){ return path; }
}
function nowInJST(){
  const s = new Date().toLocaleString('en-US', { timeZone: 'Asia/Tokyo' });
  return new Date(s);
}
function isNowWithinShift(start,end,dateObj){
  if (!start || !end) return false;
  const [sh,sm] = start.split(':').map(Number);
  const [eh,em] = end.split(':').map(Number);
  const sDate = new Date(dateObj); sDate.setHours(sh,sm,0,0);
  const eDate = new Date(dateObj); eDate.setHours(eh,em,0,0);
  if (eDate <= sDate) eDate.setDate(eDate.getDate()+1);
  return dateObj >= sDate && dateObj <= eDate;
}
function formatStars(avg){
  if (!avg) return "☆☆☆☆☆";
  const n = Math.round(avg);
  return "★★★★★☆☆☆☆☆".slice(5-n, 10-n);
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

/* ===== DOM ===== */
const nowtimeEl = document.getElementById('nowtime');
const storeTitle = document.getElementById('storeTitle');
const xBtn = document.getElementById('xBtn');
const storeChangeBtn = document.getElementById('storeChangeBtn');

const orderBtn = document.getElementById('orderBtn');
const shiftShort = document.getElementById('shiftShort');
const crowdInfo = document.getElementById('crowdInfo');

const storePick = document.getElementById('storePick');
const storeList = document.getElementById('storeList');
const storePickClose = document.getElementById('storePickClose');
const storePickBack = document.getElementById('storePickBack');
const makeMyStoreBtn = document.getElementById('makeMyStoreBtn');

const staffPass = document.getElementById('staffPass');
const passOk = document.getElementById('passOk');

const staffFull = document.getElementById('staffFull');
const staffBadge = document.getElementById('staffBadge');
const staffStoreName = document.getElementById('staffStoreName');
const logoutStaff = document.getElementById('logoutStaff');
const shiftBtn = document.getElementById('shiftBtn');
const breakBtn = document.getElementById('breakBtn');
const shiftStart = document.getElementById('shiftStart');
const shiftEnd = document.getElementById('shiftEnd');
const staffStateSel = document.getElementById('staffStateSel');
const saveShift = document.getElementById('saveShift');
const shiftList = document.getElementById('shiftList');
const staffOrderList = document.getElementById('staffOrderList');
const pendingTasksSmall = document.getElementById('pendingTasksSmall');

const emptyOrderOn = document.getElementById('emptyOrderOn');
const emptyOrderOff = document.getElementById('emptyOrderOff');
const emptyOrderState = document.getElementById('emptyOrderState');

const soundOverlay = document.getElementById('soundOverlay');
const enableSoundBtn = document.getElementById('enableSoundBtn');
const disableSoundBtn = document.getElementById('disableSoundBtn');

const orderStatusOverlay = document.getElementById('orderStatusOverlay');
const orderStatusMain = document.getElementById('orderStatusMain');
const orderStatusSub = document.getElementById('orderStatusSub');
const statusArtImg = document.getElementById('statusArtImg');
const statusReview = document.getElementById('statusReview');

const modalName = document.getElementById('modalName');
const nameModalTitle = document.getElementById('nameModalTitle');
const orderName = document.getElementById('orderName');
const okOrderName = document.getElementById('okOrderName');
const cancelOrderName = document.getElementById('cancelOrderName');

const modalMenu = document.getElementById('modalMenu');
const menuGrid = document.getElementById('menuGrid');
const backMenu = document.getElementById('backMenu');

const modalMake = document.getElementById('modalMake');
const makeTitle = document.getElementById('makeTitle');
const makerName = document.getElementById('makerName');
const makeOrderInfo = document.getElementById('makeOrderInfo');
const makeRandomReview = document.getElementById('makeRandomReview');
const deliverBtn = document.getElementById('deliverBtn');
const cancelMake = document.getElementById('cancelMake');

const artBg = document.getElementById('artBg');
const artLayer = document.getElementById('artLayer');
const artBgCtx = artBg.getContext('2d');
const artLayerCtx = artLayer.getContext('2d');
const penMode = document.getElementById('penMode');
const penSize = document.getElementById('penSize');
const clearArt = document.getElementById('clearArt');
const saveArt = document.getElementById('saveArt');
const artBgColor = document.getElementById('artBgColor');
const artPenColor = document.getElementById('artPenColor');
const rtState = document.getElementById('rtState');

const modalEat = document.getElementById('modalEat');
const servedImage = document.getElementById('servedImage');
const servedArtMini = document.getElementById('servedArtMini');
const servedArtMiniCtx = servedArtMini.getContext('2d');
const saveAllBtn = document.getElementById('saveAllBtn');
const homeFromEat = document.getElementById('homeFromEat');

const reviewStars = document.getElementById('reviewStars');
const reviewText = document.getElementById('reviewText');
const submitReviewBtn = document.getElementById('submitReviewBtn');
const eatRandomReview = document.getElementById('eatRandomReview');

/* ===== Audio assets ===== */
const audioTyaimu = new Audio(getAssetUrl('@zzcafe2800/reiji_cafe/main/tyaimu.mp3'));
const audioDelivered = new Audio(getAssetUrl('@zzcafe2800/reiji_cafe/main/ps.mp3')); // <- 要望: 提供時にps.mp3
// クリック等の許可が必要なブラウザがあるので、初回に許可を取る
const state = {
  audioUnlocked:false,
  currentStoreId:null,
  currentStore:null,
  staffs:[],
  orders:[],
  menuStats:{}, // menuId -> {avg,count}
  recentReviewsByMenu:{}, // menuId -> [{text,rating}]
  currentUser:{ role:'guest', staffId:null, staffName:null },
  currentOrderIdForClient:null,
  clientId:null,
  emptyOrderAllowed:true, // store setting
  activeSignalsUnsub:null,
  unsubStaffs:null,
  unsubOrders:null,
  unsubReviews:null,
  unsubMenuStats:null
};

let clientId = localStorage.getItem('reiji_clientId');
if (!clientId){ clientId = 'c_' + Math.random().toString(36).slice(2,9); localStorage.setItem('reiji_clientId', clientId); }
state.clientId = clientId;

/* ===== Stores & Menus config =====
  - STORES: お店名 / X / staffPass / menuSetId
  - MENU_SETS: 店に出すメニューID一覧
  - MENUS: メニュー定義（画像ベース等）
*/
const STORES = [
  {
    id:'reiji',
    name:'0時カフェ',
    staffPass:'1232',
    xUrl:'https://x.com/zzcafe_280',
    menuSetId:'set_reiji',
    background:'https://raw.githubusercontent.com/zzcafe2800/reiji_cafe/main/3739270_l.jpg'
  },
  {
    id:'zz',
    name:'zzカフェ',
    staffPass:'0000',
    xUrl:'https://x.com/zzcafe_280',
    menuSetId:'set_zz',
    background:'https://raw.githubusercontent.com/zzcafe2800/reiji_cafe/main/3739270_l.jpg'
  }
];

const MENU_SETS = {
  set_reiji: ['rate','omu','pafe','asa','tyoko'],
  set_zz: ['rate','omu']
};

const MENUS = {
  rate: { id:'rate', title:'カフェ・ラテ', imageBase:'@zzcafe2800/reiji_cafe/main/rate', frameCount:6, artBg:'#6b3b24', artPen:'#ffffff' },
  omu:  { id:'omu',  title:'オムライス', imageBase:'@zzcafe2800/reiji_cafe/main/omu',  frameCount:6, artBg:'#ffd66b', artPen:'#ff0000' },
  pafe: { id:'pafe', title:'パフェ',     imageBase:'@zzcafe2800/reiji_cafe/main/pafe', frameCount:3, artBg:'#6b3b24', artPen:'#ffffff' },
  asa:  { id:'asa',  title:'食テロ',     imageBase:'@zzcafe2800/reiji_cafe/main/asa',  frameCount:4, artBg:'#6b3b24', artPen:'#ffffff' },
  tyoko:{ id:'tyoko',title:'ケーキ',     imageBase:'@zzcafe2800/reiji_cafe/main/tyoko',frameCount:4, artBg:'#6b3b24', artPen:'#ffffff' }
};

/* ===== Firestore paths per store ===== */
function storesRoot(){ return collection(db,'stores'); }
function storeDoc(storeId){ return doc(db,'stores',storeId); }
function staffsCol(storeId){ return collection(db,'stores',storeId,'staffs'); }
function ordersCol(storeId){ return collection(db,'stores',storeId,'orders'); }
function reviewsCol(storeId){ return collection(db,'stores',storeId,'reviews'); }
function menuStatsCol(storeId){ return collection(db,'stores',storeId,'menuStats'); }
function signalsCol(storeId){ return collection(db,'stores',storeId,'signals'); }

/* ===== UI basics ===== */
setInterval(()=> nowtimeEl.textContent = nowInJST().toLocaleTimeString(), 1000);

function show(el){ el.style.display='flex'; el.setAttribute('aria-hidden','false'); }
function hide(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }

/* ===== Store Picker ===== */
function openStorePicker(){
  storeList.innerHTML = '';
  STORES.forEach(s=>{
    const row = document.createElement('div');
    row.className='store-row';
    row.innerHTML = `
      <div>
        <div class="store-name">${escapeHtml(s.name)}</div>
        <div class="small-info">メニュー:${escapeHtml(s.menuSetId)}</div>
      </div>
      <button class="small btn-green">来店</button>
    `;
    row.querySelector('button').onclick = ()=>{ selectStore(s.id); };
    storeList.appendChild(row);
  });
  storePick.style.display='flex';
}
function closeStorePicker(){ storePick.style.display='none'; }
storePickClose.onclick = closeStorePicker;
storePickBack.onclick = closeStorePicker;
storeChangeBtn.onclick = openStorePicker;
makeMyStoreBtn.onclick = ()=>{
  alert('開発中です');
};

/* ===== Store select & listeners ===== */
async function selectStore(storeId){
  const s = STORES.find(x=>x.id===storeId);
  if (!s){ alert('店が見つかりません'); return; }
  state.currentStoreId = storeId;
  state.currentStore = s;

  storeTitle.textContent = s.name;
  staffStoreName.textContent = s.name;
  xBtn.onclick = ()=> window.open(s.xUrl || 'https://x.com', '_blank');

  // background (optional)
  if (s.background){
    document.documentElement.style.background = `url("${s.background}") center center / cover no-repeat`;
    document.body.style.background = `url("${s.background}") center center / cover no-repeat`;
  }

  closeStorePicker();

  // Ensure store settings doc exists
  if (db){
    const ref = storeDoc(storeId);
    const snap = await getDoc(ref).catch(()=>null);
    if (!snap || !snap.exists()){
      await setDoc(ref, { name:s.name, emptyOrderAllowed:true, createdAt:Date.now() }).catch(()=>{});
    }
  }

  // unsubscribe old listeners
  state.unsubStaffs && state.unsubStaffs();
  state.unsubOrders && state.unsubOrders();
  state.unsubReviews && state.unsubReviews();
  state.unsubMenuStats && state.unsubMenuStats();
  state.activeSignalsUnsub && state.activeSignalsUnsub();

  // load store setting
  await loadStoreSetting();

  // start listeners
  startStaffsListener();
  startOrdersListener();
  startMenuStatsListener();
  startSignalsListener();

  // build menu UI
  buildMenu();

  // reflect button state
  updateOrderButtonState();
}

async function loadStoreSetting(){
  if (!db || !state.currentStoreId) { state.emptyOrderAllowed = true; emptyOrderState.textContent='ON'; return; }
  try{
    const snap = await getDoc(storeDoc(state.currentStoreId));
    if (snap.exists()){
      const d = snap.data();
      state.emptyOrderAllowed = !!d.emptyOrderAllowed;
      emptyOrderState.textContent = state.emptyOrderAllowed ? 'ON' : 'OFF';
    }
  }catch(e){}
}
async function setEmptyOrderAllowed(val){
  state.emptyOrderAllowed = !!val;
  emptyOrderState.textContent = state.emptyOrderAllowed ? 'ON' : 'OFF';
  if (db && state.currentStoreId){
    await updateDoc(storeDoc(state.currentStoreId), { emptyOrderAllowed: state.emptyOrderAllowed }).catch(()=>{});
  }
  updateOrderButtonState();
}
emptyOrderOn.onclick = ()=> setEmptyOrderAllowed(true);
emptyOrderOff.onclick = ()=> setEmptyOrderAllowed(false);

/* ===== Sound overlay ===== */
function showSoundOverlay(){ soundOverlay.style.display='flex'; }
function hideSoundOverlay(){ soundOverlay.style.display='none'; }
enableSoundBtn.onclick = ()=>{
  state.audioUnlocked = true;
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    ctx.resume && ctx.resume();
    ctx.close && ctx.close();
  }catch(e){}
  hideSoundOverlay();
};
disableSoundBtn.onclick = ()=>{
  state.audioUnlocked = false;
  hideSoundOverlay();
};
showSoundOverlay();

/* ===== Staffs listener ===== */
function startStaffsListener(){
  if (!db || !state.currentStoreId){
    state.staffs = [];
    renderShiftShort();
    renderShiftList();
    updateOrderButtonState();
    return;
  }
  const q1 = query(staffsCol(state.currentStoreId), orderBy('createdAt','asc'));
  state.unsubStaffs = onSnapshot(q1, snap=>{
    state.staffs = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderShiftShort();
    renderShiftList();
    updateOrderButtonState();
  });
}

function getHumanActiveStaffs(){
  const now = nowInJST();
  return state.staffs.filter(s => s.onShift && !s.breaking && isNowWithinShift(s.shiftStart,s.shiftEnd,now));
}

function renderShiftShort(){
  const active = getHumanActiveStaffs();
  if (active.length){
    shiftShort.textContent = 'シフト：' + active.map(s=>{
      const st = (s.staffState === 'busy') ? '他方の料理中' : '待機中';
      return `${s.name}（${st}）`;
    }).join(' / ');
  } else {
    shiftShort.textContent = 'シフト：無人';
  }
  // crowd
  const pending = (state.orders||[]).filter(o=> o.state==='waiting' || o.state==='inprogress').length;
  crowdInfo.textContent = pending ? `混み具合：注文 ${pending} 件` : '混み具合：空いてます';
}

function renderShiftList(){
  shiftList.innerHTML = '';
  const now = nowInJST();
  state.staffs.forEach(s=>{
    const div = document.createElement('div');
    const onNow = isNowWithinShift(s.shiftStart,s.shiftEnd,now);
    const st = (s.staffState === 'busy') ? '他方の料理中' : '待機中';
    div.innerHTML = `
      <strong>${escapeHtml(s.name)}</strong>
      <span class="small-info"> ${escapeHtml(st)} / ${escapeHtml(s.shiftStart||'--:--')}〜${escapeHtml(s.shiftEnd||'--:--')}</span>
      ${s.onShift?'<span style="color:green"> シフト中</span>':'<span style="color:gray"> -</span>'}
      ${s.breaking?'<span style="color:orange"> 休憩中</span>':''}
      ${onNow?'<span class="small-info">（現在この時間）</span>':''}
    `;
    const del = document.createElement('button');
    del.className='small';
    del.textContent='削除';
    del.style.marginLeft='8px';
    del.onclick = async ()=>{
      if (!db) return;
      await deleteDoc(doc(db,'stores',state.currentStoreId,'staffs',s.id)).catch(()=>{});
    };
    div.appendChild(del);
    shiftList.appendChild(div);
  });
}

/* ===== Orders listener ===== */
function startOrdersListener(){
  if (!db || !state.currentStoreId){
    state.orders = [];
    renderOrderLists();
    return;
  }
  const q2 = query(ordersCol(state.currentStoreId), orderBy('createdAt','asc'));
  state.unsubOrders = onSnapshot(q2, snap=>{
    state.orders = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderOrderLists();
    renderShiftShort();
    updateClientOverlay();
  });
}

function renderOrderLists(){
  staffOrderList.innerHTML = '';
  const list = state.orders.filter(o => o.state !== 'delivered' && o.state !== 'cancelled');
  list.forEach(o=>{
    const div = document.createElement('div');
    div.className='order-item';
    const left = document.createElement('div');
    const itemTitle = MENUS[o.item]?.title || o.item;
    left.innerHTML = `
      <strong>${escapeHtml(o.name)}</strong>
      <div class="small-info">${escapeHtml(itemTitle)} / 状態:${escapeHtml(o.state)}</div>
    `;
    const right = document.createElement('div');

    if (o.state === 'waiting'){
      const btn = document.createElement('button');
      btn.className='small btn-green';
      btn.textContent='対応';
      btn.onclick = ()=> assignOrderToCurrentStaff(o.id);
      right.appendChild(btn);
    } else if (o.state === 'inprogress'){
      const info = document.createElement('div');
      info.className='small-info';
      info.textContent = `担当:${o.assignedToName||''}`;
      right.appendChild(info);
      const makeBtn = document.createElement('button');
      makeBtn.className='small';
      makeBtn.textContent='制作';
      makeBtn.onclick = ()=> openMakeModal(o);
      right.appendChild(makeBtn);
    }

    div.appendChild(left);
    div.appendChild(right);
    staffOrderList.appendChild(div);
  });

  const pending = (state.orders||[]).filter(o=> o.state==='waiting' || o.state==='inprogress').length;
  pendingTasksSmall.textContent = pending ? ` 未処理:${pending}` : '';
}

/* ===== Reviews / Menu stats =====
  - menuStats: {avg,count} を stores/{storeId}/menuStats/{menuId} に保存
  - submit時にクライアント側で軽く更新（厳密性は多少ズレる可能性あり）
*/
function startMenuStatsListener(){
  if (!db || !state.currentStoreId) return;
  const q = query(menuStatsCol(state.currentStoreId), orderBy('updatedAt','desc'));
  state.unsubMenuStats = onSnapshot(q, snap=>{
    const stats = {};
    snap.docs.forEach(d=>{
      stats[d.id] = d.data();
    });
    state.menuStats = stats;
    // menu表示更新（星バッジ）
    buildMenu();
  });

  // recent reviews (軽量表示用): 最新200
  const q2 = query(reviewsCol(state.currentStoreId), orderBy('ts','desc'), limit(200));
  state.unsubReviews = onSnapshot(q2, snap=>{
    const byMenu = {};
    snap.docs.forEach(d=>{
      const r = d.data();
      if (!r || !r.menuId) return;
      if (!byMenu[r.menuId]) byMenu[r.menuId] = [];
      byMenu[r.menuId].push({ text:r.text||'', rating:r.rating||0 });
    });
    state.recentReviewsByMenu = byMenu;
  });
}

function pickRandomReviewText(menuId){
  const arr = state.recentReviewsByMenu[menuId] || [];
  if (!arr.length) return null;
  const r = arr[Math.floor(Math.random()*arr.length)];
  const stars = "★★★★★☆☆☆☆☆".slice(5-(r.rating||0), 10-(r.rating||0));
  const txt = (r.text||'').trim();
  if (!txt) return `${stars}`;
  return `${stars} ${txt.slice(0, 40)}${txt.length>40?'…':''}`;
}

/* ===== Menu build ===== */
async function buildMenu(){
  menuGrid.innerHTML = '';
  const store = state.currentStore;
  if (!store) return;
  const setId = store.menuSetId;
  const ids = MENU_SETS[setId] || [];

  for (const id of ids){
    const it = MENUS[id];
    if (!it) continue;

    const div = document.createElement('div'); div.className='menu-item';
    const img = document.createElement('img'); img.className='menu-thumb';
    img.src = getAssetUrl(it.imageBase + '1.png');

    const stat = state.menuStats[it.id];
    const avg = stat?.avg || 0;
    const badge = document.createElement('div');
    badge.className='star-badge';
    badge.textContent = avg ? `${formatStars(avg)} ${avg.toFixed(1)}` : '☆☆☆☆☆';
    div.appendChild(badge);

    div.appendChild(img);
    const label = document.createElement('div');
    label.textContent = it.title;
    div.appendChild(label);

    div.onclick = ()=> onMenuSelect(it);
    menuGrid.appendChild(div);
  }
}

/* ===== Order button enable logic =====
  - BOTなし
  - emptyOrderAllowed=false かつ active staff = 0 のとき disable
*/
function updateOrderButtonState(){
  const active = getHumanActiveStaffs();
  const canOrder = state.emptyOrderAllowed ? true : (active.length > 0);
  if (canOrder){
    orderBtn.classList.remove('disabled');
  } else {
    orderBtn.classList.add('disabled');
  }
}

/* ===== Modals ===== */
function showModal(el){ el.style.display='flex'; el.setAttribute('aria-hidden','false'); }
function hideModal(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }

/* ===== Client order flow ===== */
orderBtn.onclick = ()=>{
  if (orderBtn.classList.contains('disabled')) return;
  nameModalTitle.textContent = 'ゲーム内の名前（客）';
  orderName.value = '';
  showModal(modalName);
};
cancelOrderName.onclick = ()=>{
  hideModal(modalName);
  orderName.value = '';
};
okOrderName.onclick = ()=>{
  const name = orderName.value.trim();
  if (!name){ alert('名前を入力してください'); return; }
  hideModal(modalName);
  showModal(modalMenu);

  // tyaium: 「メニュー画像を押した時だけ」鳴らしたい→ここで信号送る（押した本人 + その店のスタッフ）
  sendTyaimuSignalToMeAndActiveStaffs();
};

backMenu.onclick = ()=> hideModal(modalMenu);

/* tyaimu signal */
async function sendTyaimuSignalToMeAndActiveStaffs(){
  if (!db || !state.currentStoreId) {
    // local
    if (state.audioUnlocked){ try{ audioTyaimu.currentTime=0; audioTyaimu.play().catch(()=>{}); }catch(e){} }
    return;
  }
  const activeStaffs = getHumanActiveStaffs();
  const targets = [state.clientId, ...activeStaffs.map(s=>s.clientId).filter(Boolean)];
  // no duplicates
  const uniq = Array.from(new Set(targets));
  try{
    await addDoc(signalsCol(state.currentStoreId), { type:'tyaimu', to: uniq, ts: Date.now() });
  }catch(e){}
}

/* signals listener: play only if to includes my clientId */
function startSignalsListener(){
  if (!db || !state.currentStoreId) return;
  const q = query(signalsCol(state.currentStoreId), orderBy('ts','asc'), limit(200));
  let lastTs = 0;
  state.activeSignalsUnsub = onSnapshot(q, snap=>{
    snap.docs.forEach(ds=>{
      const s = ds.data();
      if (!s || !s.ts || s.ts <= lastTs) return;
      lastTs = s.ts;
      if (s.type === 'tyaimu'){
        const to = s.to || [];
        if (Array.isArray(to) && to.includes(state.clientId)){
          if (state.audioUnlocked){
            try{ audioTyaimu.currentTime=0; audioTyaimu.play().catch(()=>{}); }catch(e){}
          }
        }
      }
    });
  });
}

/* ===== Create order ===== */
async function onMenuSelect(menuItem){
  hideModal(modalMenu);
  const customerName = orderName.value.trim();
  if (!customerName){ alert('名前がありません'); return; }

  // もし emptyOrderAllowed=false で 無人なら弾く（メニュー出てても）
  const active = getHumanActiveStaffs();
  if (!state.emptyOrderAllowed && active.length === 0){
    alert('現在無人のため注文できません');
    return;
  }

  const createdAt = Date.now();
  const orderObj = {
    name: customerName,
    item: menuItem.id,
    state: 'waiting',
    createdAt,
    assignedTo: null,
    assignedToName: null,
    clientId: state.clientId,
    // realtime art preview:
    artPreviewJpg: null,
    artBg: menuItem.artBg || '#6b3b24',
    deliveredAt: null,
    servedImageUrl: getAssetUrl(menuItem.imageBase + '1.png')
  };

  if (!db || !state.currentStoreId){
    alert('Firestoreが利用できません');
    return;
  }
  try{
    const ref = await addDoc(ordersCol(state.currentStoreId), orderObj);
    state.currentOrderIdForClient = ref.id;
    showClientStatus('現在対応待ち中', null, menuItem.id);
  }catch(e){
    console.warn(e);
    alert('注文に失敗しました');
  }
}

/* ===== Client overlay ===== */
function showClientStatus(text, artJpgDataUrl, menuId){
  orderStatusMain.textContent = text;
  orderStatusSub.textContent = 'そのままでお待ちください';
  orderStatusOverlay.style.display = 'flex';

  const rev = menuId ? pickRandomReviewText(menuId) : null;
  if (rev){
    statusReview.style.display='block';
    statusReview.textContent = '口コミ: ' + rev;
  } else {
    statusReview.style.display='none';
  }

  if (artJpgDataUrl){
    statusArtImg.style.display='block';
    statusArtImg.src = artJpgDataUrl;
  } else {
    statusArtImg.style.display='none';
    statusArtImg.src = '';
  }
}
function hideClientStatus(){
  orderStatusOverlay.style.display = 'none';
  statusArtImg.style.display='none';
  statusReview.style.display='none';
}

/* ===== Client overlay update from orders ===== */
async function updateClientOverlay(){
  const id = state.currentOrderIdForClient;
  if (!id) return;
  const o = state.orders.find(x=>x.id===id);
  if (!o) return;

  if (o.state === 'waiting'){
    showClientStatus('現在対応待ち中', null, o.item);
  } else if (o.state === 'inprogress'){
    // realtime art preview
    showClientStatus('現在調理中…', o.artPreviewJpg || null, o.item);
  } else if (o.state === 'delivered'){
    hideClientStatus();
    await showClientServed(o);
    // 提供時: スマホならバイブ、PCも音
    if (state.audioUnlocked){
      try{ audioDelivered.currentTime=0; audioDelivered.play().catch(()=>{}); }catch(e){}
    }
    try{
      if (navigator.vibrate) navigator.vibrate([200,80,200]);
    }catch(e){}
  } else if (o.state === 'cancelled'){
    showClientStatus('注文がキャンセルされました', null, o.item);
    setTimeout(()=>{ hideClientStatus(); state.currentOrderIdForClient=null; }, 4000);
  }
}

/* ===== Staff login ===== */
passOk.onclick = ()=>{
  const store = state.currentStore;
  if (!store){ alert('先にお店を選んでください'); return; }
  const pass = staffPass.value;
  if (pass !== store.staffPass){ alert('パスワードが違います'); return; }

  nameModalTitle.textContent = '店員の名前';
  orderName.value = '';
  showModal(modalName);

  okOrderName.onclick = async ()=>{
    const name = orderName.value.trim();
    if (!name){ alert('名前'); return; }
    hideModal(modalName);

    if (!db) return;
    try{
      const ref = await addDoc(staffsCol(state.currentStoreId), {
        name,
        clientId: state.clientId,
        shiftStart:'09:00',
        shiftEnd:'17:00',
        onShift:true,
        breaking:false,
        staffState:'waiting', // 待機中 / busy
        createdAt: Date.now()
      });
      enterStaffFull(name, ref.id);
    }catch(e){
      console.warn(e);
      alert('店員ログイン失敗');
    }
  };

  // cancel must work
  cancelOrderName.onclick = ()=>{
    hideModal(modalName);
    orderName.value = '';
    // 戻す（客側用のデフォルトに復元）
    okOrderName.onclick = null;
  };
};

function enterStaffFull(name, staffId){
  state.currentUser = { role:'staff', staffId, staffName:name };
  staffBadge.textContent = name;
  staffFull.classList.add('show');
}

logoutStaff.onclick = async ()=>{
  const id = state.currentUser.staffId;
  if (db && id && state.currentStoreId){
    await deleteDoc(doc(db,'stores',state.currentStoreId,'staffs',id)).catch(()=>{});
  }
  state.currentUser = { role:'guest', staffId:null, staffName:null };
  staffFull.classList.remove('show');
};

/* shift toggle */
shiftBtn.onclick = async ()=>{
  if (!db) return;
  const id = state.currentUser.staffId; if (!id) return;
  await updateDoc(doc(db,'stores',state.currentStoreId,'staffs',id), { onShift:true, breaking:false }).catch(()=>{});
};
breakBtn.onclick = async ()=>{
  if (!db) return;
  const id = state.currentUser.staffId; if (!id) return;
  await updateDoc(doc(db,'stores',state.currentStoreId,'staffs',id), { onShift:false, breaking:true }).catch(()=>{});
};

saveShift.onclick = async ()=>{
  if (!db) return;
  const id = state.currentUser.staffId; if (!id) return;
  const payload = {
    shiftStart: shiftStart.value || '09:00',
    shiftEnd: shiftEnd.value || '17:00',
    staffState: staffStateSel.value || 'waiting'
  };
  await updateDoc(doc(db,'stores',state.currentStoreId,'staffs',id), payload).catch(()=>{});
};

/* ===== Assign order ===== */
async function assignOrderToCurrentStaff(orderId){
  if (!db) return;
  const staffId = state.currentUser.staffId;
  if (!staffId){ alert('スタッフとしてログインしてください'); return; }
  const s = state.staffs.find(x=>x.id===staffId);
  await updateDoc(doc(db,'stores',state.currentStoreId,'orders',orderId), {
    state:'inprogress',
    assignedTo: staffId,
    assignedToName: s?.name || ''
  }).catch(()=>{});
}

/* ===== Realtime Art (Fix eraser bug) =====
  - bg canvas = 背景固定
  - layer canvas = 描画/消しゴム（透明消去）
  - 保存時: 背景 + layerを合成して jpeg/png を作る（消しゴムで背景が消えない）
*/
function initArtCanvas(bgColor){
  artBgCtx.clearRect(0,0,artBg.width,artBg.height);
  artBgCtx.fillStyle = bgColor || artBgColor.value || '#6b3b24';
  artBgCtx.beginPath(); artBgCtx.arc(120,120,100,0,Math.PI*2); artBgCtx.fill();

  artLayerCtx.clearRect(0,0,artLayer.width,artLayer.height);
  artLayerCtx.lineCap='round';
  artLayerCtx.lineJoin='round';
}
initArtCanvas();

function getEventPos(e, canvas){
  const r = canvas.getBoundingClientRect();
  const t = e.touches ? e.touches[0] : null;
  const cx = t ? t.clientX : e.clientX;
  const cy = t ? t.clientY : e.clientY;
  return { x: (cx - r.left) * (canvas.width / r.width), y: (cy - r.top) * (canvas.height / r.height) };
}

let artDrawing=false;
let dirty=false;

function drawSegment(p1,p2, tool, w, color){
  if (tool === 'draw'){
    artLayerCtx.globalCompositeOperation='source-over';
    artLayerCtx.strokeStyle = color || '#fff';
    artLayerCtx.lineWidth = w;
  } else {
    // erase only on layer
    artLayerCtx.globalCompositeOperation='destination-out';
    artLayerCtx.lineWidth = w;
  }
  artLayerCtx.beginPath();
  artLayerCtx.moveTo(p1.x,p1.y);
  artLayerCtx.lineTo(p2.x,p2.y);
  artLayerCtx.stroke();
  artLayerCtx.globalCompositeOperation='source-over';
}

let lastPoint=null;

artLayer.addEventListener('mousedown', (e)=>{
  artDrawing=true;
  lastPoint = getEventPos(e, artLayer);
});
artLayer.addEventListener('mousemove', (e)=>{
  if (!artDrawing) return;
  const p = getEventPos(e, artLayer);
  const tool = penMode.value;
  const w = parseInt(penSize.value,10);
  const color = artPenColor.value || '#fff';
  drawSegment(lastPoint, p, tool, w, color);
  lastPoint = p;
  dirty=true;
});
window.addEventListener('mouseup', ()=>{
  if (artDrawing){ artDrawing=false; lastPoint=null; }
});
artLayer.addEventListener('touchstart', (e)=>{ e.preventDefault(); artDrawing=true; lastPoint=getEventPos(e, artLayer); }, {passive:false});
artLayer.addEventListener('touchmove', (e)=>{ e.preventDefault(); if(!artDrawing) return; const p=getEventPos(e, artLayer); const tool=penMode.value; const w=parseInt(penSize.value,10); drawSegment(lastPoint,p,tool,w,artPenColor.value); lastPoint=p; dirty=true; }, {passive:false});
artLayer.addEventListener('touchend', (e)=>{ e.preventDefault(); artDrawing=false; lastPoint=null; }, {passive:false});

clearArt.onclick = ()=>{
  initArtCanvas(artBgColor.value);
  dirty=true;
};

artBgColor.oninput = ()=>{
  initArtCanvas(artBgColor.value);
  dirty=true;
};

/* ===== Make modal / realtime send (8秒ごと・変更時のみ・軽量JPEG) ===== */
let currentMakeOrderId=null;
let currentMakeOrder=null;
let rtTimer=null;
let lastSentHash='';

function canvasToJpegDataUrl(canvas, quality=0.45){
  // layer+bg合成を一時canvasに
  const tmp = document.createElement('canvas');
  tmp.width = canvas.width;
  tmp.height = canvas.height;
  const t = tmp.getContext('2d');
  // bg
  t.drawImage(artBg,0,0,tmp.width,tmp.height);
  // layer
  t.drawImage(artLayer,0,0,tmp.width,tmp.height);
  return tmp.toDataURL('image/jpeg', quality);
}
function quickHash(str){
  // 軽い比較用（完全でなくてOK）
  let h=0;
  for(let i=0;i<str.length;i++){ h = ((h<<5)-h) + str.charCodeAt(i); h|=0; }
  return String(h);
}

async function openMakeModal(order){
  if (!db) return;
  currentMakeOrderId = order.id;
  currentMakeOrder = order;
  makerName.textContent = order.assignedToName || '';
  makeTitle.textContent = `制作（担当：${order.assignedToName || ''}）`;
  makeOrderInfo.textContent = `${order.name} / ${MENUS[order.item]?.title || order.item}`;
  makeRandomReview.textContent = pickRandomReviewText(order.item) || '—';

  // init art colors by menu
  const cfg = MENUS[order.item] || MENUS.rate;
  artBgColor.value = cfg.artBg || '#6b3b24';
  artPenColor.value = cfg.artPen || '#ffffff';
  initArtCanvas(artBgColor.value);
  dirty = true;
  lastSentHash = '';

  showModal(modalMake);

  // start realtime timer: 8s
  stopRealtimeTimer();
  rtTimer = setInterval(async ()=>{
    if (!currentMakeOrderId) return;
    if (!dirty) { rtState.textContent='リアルタイム: 変化なし'; return; }
    const jpg = canvasToJpegDataUrl(artLayer, 0.40); // 低画質
    const h = quickHash(jpg);
    if (h === lastSentHash){ dirty=false; rtState.textContent='リアルタイム: 同一'; return; }
    lastSentHash = h;
    dirty=false;
    rtState.textContent='リアルタイム: 送信...';
    await updateDoc(doc(db,'stores',state.currentStoreId,'orders',currentMakeOrderId), {
      artPreviewJpg: jpg,
      artBg: artBgColor.value || '#6b3b24',
      artUpdatedAt: Date.now()
    }).catch(()=>{});
    rtState.textContent='リアルタイム: OK';
  }, 8000);
}

function stopRealtimeTimer(){
  if (rtTimer){ clearInterval(rtTimer); rtTimer=null; }
}

cancelMake.onclick = ()=>{
  stopRealtimeTimer();
  hideModal(modalMake);
  currentMakeOrderId=null;
  currentMakeOrder=null;
};

saveArt.onclick = async ()=>{
  if (!db || !currentMakeOrderId) return;
  const jpg = canvasToJpegDataUrl(artLayer, 0.55);
  await updateDoc(doc(db,'stores',state.currentStoreId,'orders',currentMakeOrderId), {
    artPreviewJpg: jpg,
    artBg: artBgColor.value || '#6b3b24',
    artSavedAt: Date.now()
  }).catch(()=>{});
  alert('アートを保存しました');
};

deliverBtn.onclick = async ()=>{
  if (!db || !currentMakeOrderId) return;
  // 提供: delivered
  await updateDoc(doc(db,'stores',state.currentStoreId,'orders',currentMakeOrderId), {
    state:'delivered',
    deliveredAt: Date.now()
  }).catch(()=>{});
  stopRealtimeTimer();
  hideModal(modalMake);
  currentMakeOrderId=null;
  currentMakeOrder=null;
  alert('提供しました');
};

/* ===== Served UI ===== */
async function showClientServed(order){
  // メニュー画像（とりあえず1枚）
  const cfg = MENUS[order.item] || MENUS.rate;
  servedImage.src = getAssetUrl(cfg.imageBase + '1.png');

  // art mini
  servedArtMiniCtx.clearRect(0,0,servedArtMini.width,servedArtMini.height);
  // bg
  servedArtMiniCtx.fillStyle = order.artBg || cfg.artBg || '#6b3b24';
  servedArtMiniCtx.fillRect(0,0,servedArtMini.width,servedArtMini.height);
  // preview img
  if (order.artPreviewJpg){
    const img = new Image();
    img.src = order.artPreviewJpg;
    await new Promise(r=>{ img.onload=r; img.onerror=r; });
    // cover-fit
    const cw=servedArtMini.width, ch=servedArtMini.height;
    const iw=img.width||1, ih=img.height||1;
    const s = Math.max(cw/iw, ch/ih);
    const dw=iw*s, dh=ih*s;
    const dx=(cw-dw)/2, dy=(ch-dh)/2;
    servedArtMiniCtx.drawImage(img, dx, dy, dw, dh);
  }

  // random review small
  eatRandomReview.textContent = pickRandomReviewText(order.item) ? ('口コミ: ' + pickRandomReviewText(order.item)) : '';

  // review state reset
  setRating(0);
  reviewText.value = '';

  showModal(modalEat);
}

/* ===== Save image fix (no squish) ===== */
function drawImageContain(ctx, img, x, y, w, h){
  const iw = img.width||1, ih = img.height||1;
  const s = Math.min(w/iw, h/ih);
  const dw = iw*s, dh = ih*s;
  const dx = x + (w-dw)/2;
  const dy = y + (h-dh)/2;
  ctx.drawImage(img, dx, dy, dw, dh);
}

saveAllBtn.onclick = async ()=>{
  const id = state.currentOrderIdForClient;
  const o = state.orders.find(x=>x.id===id);
  if (!o) return;

  const tmp = document.createElement('canvas');
  tmp.width = 1200;
  tmp.height = 900;
  const t = tmp.getContext('2d');
  t.fillStyle = '#fff8ef';
  t.fillRect(0,0,tmp.width,tmp.height);

  // main image
  const main = new Image();
  main.crossOrigin='anonymous';
  main.src = servedImage.src;
  await new Promise(r=>{ main.onload=r; main.onerror=r; });
  drawImageContain(t, main, 60, 40, 760, 760);

  // art mini
  t.drawImage(servedArtMini, 860, 60, 280, 280);

  const a = document.createElement('a');
  a.href = tmp.toDataURL('image/png');
  a.download = 'served_save.png';
  a.click();
};

/* ===== Home from eat ===== */
homeFromEat.onclick = ()=>{
  hideModal(modalEat);
  state.currentOrderIdForClient = null;
};

/* ===== Review UI ===== */
let currentRating = 0;
function setRating(n){
  currentRating = n;
  [...reviewStars.querySelectorAll('span')].forEach(sp=>{
    const k = parseInt(sp.dataset.n,10);
    sp.classList.toggle('on', k <= n);
    sp.textContent = (k <= n) ? '★' : '☆';
  });
}
reviewStars.onclick = (e)=>{
  const sp = e.target.closest('span');
  if (!sp) return;
  setRating(parseInt(sp.dataset.n,10));
};

submitReviewBtn.onclick = async ()=>{
  const id = state.currentOrderIdForClient;
  const o = state.orders.find(x=>x.id===id);
  if (!o){ alert('注文が見つかりません'); return; }
  const txt = (reviewText.value || '').trim();
  const rating = clamp(currentRating,0,5);
  if (!rating && !txt){ alert('星かコメントを入れてください'); return; }
  if (!db) return;

  await addDoc(reviewsCol(state.currentStoreId), {
    menuId: o.item,
    text: txt,
    rating,
    ts: Date.now()
  }).catch(()=>{});

  // menuStats をクライアント側で軽く更新（厳密性より手軽さ優先）
  const statRef = doc(db,'stores',state.currentStoreId,'menuStats',o.item);
  try{
    const snap = await getDoc(statRef);
    let avg=0, count=0;
    if (snap.exists()){
      const d = snap.data();
      avg = d.avg || 0;
      count = d.count || 0;
    }
    const newCount = count + 1;
    const newAvg = ((avg * count) + rating) / newCount;
    await setDoc(statRef, { avg:newAvg, count:newCount, updatedAt: Date.now() }, { merge:true });
  }catch(e){}

  alert('口コミを送信しました');
};

/* ===== Start ===== */
openStorePicker();

/* orders overlay update trigger (also when no realtime) */
orderStatusOverlay.addEventListener('click', ()=>{ /* tap to close? */ });

</script>
</body>
</html>
